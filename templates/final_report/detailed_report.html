{% extends 'layout.html' %}

{% block content %}
<style>
/* Final Report specific styling */
.final-report-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 2rem 0;
    position: relative;
    overflow-x: hidden;
}

.final-report-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(0,0,0,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.5;
    pointer-events: none;
}

/* Page Title Styling */
.page-title {
    color: #2c3e50;
    font-weight: 800;
    font-size: 3rem;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.8s ease;
}

.page-subtitle {
    color: #6c757d;
    font-size: 1.2rem;
    margin-bottom: 2rem;
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.8s ease 0.2s both;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.report-header {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    padding: 2.5rem;
    border: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.report-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    overflow: hidden;
    border: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.report-card-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 1.5rem;
    border: none;
}

.report-card-body {
    padding: 0;
}

.metric-card {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-present {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.status-absent {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
}

.status-leave {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    color: white;
}

.status-permission {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
}

.employee-selection-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.9);
}

.employee-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.employee-item .form-check-input {
    margin-top: 0;
    margin-right: 0.5rem;
    flex-shrink: 0;
}

.employee-item .form-check-label {
    margin-bottom: 0;
    flex: 1;
    cursor: pointer;
}

.employee-selection-container .form-check {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.employee-selection-container .form-check .form-check-input {
    margin-top: 0;
    margin-right: 0.5rem;
    flex-shrink: 0;
}

.employee-selection-container .form-check .form-check-label {
    margin-bottom: 0;
    flex: 1;
    cursor: pointer;
}

/* Enhanced Form Controls */
.form-control:focus,
.form-select:focus {
    border-color: #2c3e50;
    box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
}

/* Employee Count Badge */
#selectedEmployeeCount {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    font-weight: 600;
}

/* Clear Filters Button */
#clearFiltersBtn {
    transition: all 0.3s ease;
}

#clearFiltersBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
}

.filter-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
}

.auto-sync-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    font-size: 0.9rem;
    font-weight: 600;
    display: none;
}

.auto-sync-indicator.show {
    display: block;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.table-responsive {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.table th {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.8rem;
}

.table td {
    border: none;
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.table tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: rgba(52, 73, 94, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.no-data-message {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-size: 1.1rem;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2c3e50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Google Sheets Style Table */
#finalReportTable {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    border-collapse: separate;
    border-spacing: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

#finalReportTable thead th {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 1.25rem 0.75rem;
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    vertical-align: middle;
    text-align: center;
    border-bottom: 3px solid #1a252f;
}

#finalReportTable thead th i {
    margin-right: 0.5rem;
    font-size: 0.8rem;
    opacity: 0.9;
}

#finalReportTable tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid #f0f0f0;
    background: white;
}

#finalReportTable tbody tr:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #2c3e50;
}

#finalReportTable tbody tr:nth-child(even) {
    background: #fafbfc;
}

#finalReportTable tbody tr:nth-child(even):hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

#finalReportTable tbody td {
    padding: 1.25rem 0.75rem;
    vertical-align: middle;
    border: none;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
}

#finalReportTable tbody td:first-child {
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
}

#finalReportTable tfoot tr {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border-top: 4px solid #1a252f;
    color: white;
}

#finalReportTable tfoot td {
    padding: 1.5rem 0.75rem;
    font-weight: 800;
    font-size: 1.1rem;
    border: none;
    text-align: center;
    vertical-align: middle;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

#finalReportTable tfoot td:first-child {
    text-align: left;
    font-weight: 800;
}

/* Employee Info Styling */
.employee-info {
    min-width: 200px;
}

.employee-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Fingerprint Badge */
.fingerprint-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

/* Department Text */
.department-text {
    display: inline-block;
    font-weight: 500;
    font-size: 0.9rem;
    color: #495057;
    text-align: center;
    padding: 0.25rem 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    min-width: 100px;
}

/* Modern Button Styling */
.btn {
    border-radius: 12px;
    font-weight: 700;
    padding: 0.875rem 2rem;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-size: 0.9rem;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border: none;
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
}

.btn-outline-light {
    border: 2px solid #2c3e50;
    color: #2c3e50;
    background: transparent;
}

.btn-outline-light:hover {
    background: #2c3e50;
    color: white;
    border-color: #2c3e50;
}

.btn-light {
    background: rgba(255, 255, 255, 0.9);
    color: #2c3e50;
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 600;
}

.btn-light:hover {
    background: white;
    color: #2c3e50;
    border-color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Metric Badges */
.metric-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    min-width: 40px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.metric-badge.present {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.absent {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.annual-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}


.metric-badge.unpaid-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.paid-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.permission {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.working {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.total {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.dayoff {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

/* Extra Time Badge Styling */
.badge.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.badge.bg-warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
}

.badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

.metric-badge.summary {
    background: linear-gradient(135deg, #212529 0%, #495057 100%);
    color: white;
    font-size: 1rem;
    padding: 0.75rem 1.25rem;
}

/* Attendance Percentage */
.attendance-percentage {
    font-weight: 700;
    font-size: 1.1rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    color: white;
    display: inline-block;
    min-width: 60px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.attendance-percentage.summary {
    background: linear-gradient(135deg, #212529 0%, #495057 100%);
    font-size: 1.2rem;
    padding: 0.75rem 1.25rem;
}

/* Sticky Header */
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

/* Table Responsive Enhancements */
.table-responsive {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
}

/* Remove white space and improve table layout */
#finalReportTable {
    width: 100%;
    table-layout: fixed;
    min-width: 1200px;
}

.report-card-body {
    padding: 0 !important;
    overflow-x: auto;
}

/* Ensure table fills container */
.final-report-container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 1rem;
}

.report-card {
    width: 100%;
    margin: 0;
}

/* Print Styles */
@media print {
    .final-report-container {
        background: white !important;
    }
    
    .report-header {
        background: white !important;
        box-shadow: none !important;
    }
    
    .filter-section {
        display: none !important;
    }
    
    #finalReportTable {
        box-shadow: none !important;
    }
    
    #finalReportTable thead th {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    #finalReportTable tbody tr {
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .metric-badge {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .attendance-percentage {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
}

/* Remove excessive white space */
.container-fluid {
    padding: 0;
    margin: 0;
    max-width: 100%;
}

.final-report-container {
    padding: 0.5rem;
    margin: 0;
    max-width: 100%;
}

.report-card {
    margin-bottom: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Ensure table takes full width */
.table-responsive {
    width: 100%;
    margin: 0;
    padding: 0;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .final-report-container {
        padding: 0.25rem;
    }
    
    .report-header {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    #finalReportTable thead th,
    #finalReportTable tbody td {
        padding: 0.5rem 0.25rem;
    }
    
    .metric-badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        min-width: 30px;
    }
    
    .attendance-percentage {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        min-width: 50px;
    }
    
    .employee-info {
        min-width: 150px;
    }
    
    .employee-avatar {
        width: 30px;
        height: 30px;
    }
    
    .day-logs-header {
        padding: 12px 15px;
    }
    
    .day-logs-header .d-flex.flex-column {
        gap: 10px;
    }
    
    .day-logs-header .d-flex.flex-wrap {
        gap: 0.5rem !important;
        justify-content: flex-start;
    }
    
    .day-logs-container {
        margin: 2px;
        padding: 10px;
    }
    
    .day-logs-header .badge {
        font-size: 0.75rem;
        padding: 0.3em 0.5em;
    }
}

/* Permission Request Section Styles */
.permission-request-section {
    border-left: 4px solid #007bff;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.permission-request-section h6 {
    color: #007bff;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
    margin-bottom: 12px;
}

.permission-detail {
    font-size: 0.9rem;
    line-height: 1.4;
}

.permission-detail strong {
    color: #495057;
    font-weight: 600;
}

.permission-detail .badge {
    font-size: 0.8rem;
    margin: 0 2px;
}

/* Detailed Attendance Report specific styles */
.expand-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px solid #e3e6f0;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    color: #495057;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.expand-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.expand-btn:hover::before {
    left: 100%;
}

.expand-btn:hover {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.expand-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
}

.expand-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.expand-icon {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 10px;
    font-weight: bold;
}

.expand-btn.expanded .expand-icon {
    transform: rotate(90deg);
}

.expand-btn.expanded {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.expandable-row {
    background-color: #f8f9fa;
    border-top: none !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-10px);
}

.expandable-row td {
    padding: 0 !important;
    border: none !important;
}

.expandable-row.expanded {
    max-height: 2000px;
    opacity: 1;
    transform: translateY(0);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.detailed-logs-container {
    background: white;
    border-radius: 8px;
    margin: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.detailed-logs-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 12px 20px;
    border-bottom: 1px solid #e9ecef;
    overflow: hidden;
    word-wrap: break-word;
}

.detailed-logs-header h6 {
    white-space: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.detailed-logs-content {
    padding: 0;
}

.logs-table-container {
    padding: 0;
    overflow-x: auto;
    width: 100%;
}

.logs-table-container table {
    margin: 0;
    font-size: 0.9rem;
    width: 100%;
    table-layout: auto;
    min-width: 100%;
}

.logs-table-container th {
    background-color: #f8f9fa;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 12px;
    border-bottom: 2px solid #dee2e6;
}

.logs-table-container td {
    padding: 8px 12px;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
}

.logs-table-container tbody tr:hover {
    background-color: #f8f9fa;
}

.loading-spinner {
    background-color: #f8f9fa;
}

.no-logs-message {
    background-color: #f8f9fa;
    color: #6c757d;
}

/* Animation for expandable rows */
.expandable-row {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 500px;
    }
}

/* Enhanced main table styling */
.table tbody tr {
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.table tbody tr:hover {
    background-color: #f8f9ff;
    border-left-color: #667eea;
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.table tbody tr.expanded {
    background-color: #f0f4ff;
    border-left-color: #667eea;
}

/* Enhanced status badges in main table */
.table .badge {
    font-size: 0.8rem;
    padding: 0.4em 0.7em;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table .badge.bg-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.table .badge.bg-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
    color: #212529 !important;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
}

.table .badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d, #495057) !important;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .expand-btn {
        width: 28px;
        height: 28px;
    }
    
    .expand-icon {
        font-size: 10px;
    }
    
    .detailed-logs-container {
        margin: 5px;
    }
    
    .detailed-logs-header {
        padding: 8px 15px;
    }
    
    .detailed-logs-header h6 {
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .logs-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .logs-table-container table {
        font-size: 0.8rem;
        min-width: 600px;
    }
    
    .logs-table-container th,
    .logs-table-container td {
        padding: 6px 8px;
    }
}

/* Select All checkbox styling */
#selectAll:indeterminate {
    background-color: #0d6efd;
    border-color: #0d6efd;
    position: relative;
}

#selectAll:indeterminate::after {
    content: '';
    display: block;
    width: 8px;
    height: 2px;
    background-color: white;
    margin: 6px auto;
    border-radius: 1px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Enhanced checkbox visual feedback */
.employee-checkbox:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.employee-checkbox:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Smooth transitions for all checkboxes */
.employee-checkbox, #selectAll {
    transition: all 0.2s ease;
}
</style>

<div class="final-report-container">
    <!-- Auto-sync indicator -->
    <div id="autoSyncIndicator" class="auto-sync-indicator">
        <i class="fas fa-sync-alt me-2"></i>
        <span>Auto-syncing data...</span>
    </div>

    <div class="container-fluid">
        <!-- Report Header -->
        <div class="report-header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="page-title mb-2">
                        <i class="fas fa-chart-line me-2"></i>
                        Detailed Attendance Report
                    </h1>
                    <p class="page-subtitle mb-0">Comprehensive attendance report with expandable employee logs and auto-sync</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Detailed Attendance Report</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        {% if not all_user_reports %}
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i>
                Report Filters
            </h5>
            <form method="GET" action="{{ url_for('final_report.detailed_attendance_report') }}" id="reportForm">
                <div class="row mb-3">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-check me-1 text-primary"></i>
                            Start Date <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" required>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-times me-1 text-primary"></i>
                            End Date <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" required>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="department_id" class="form-label">
                            <i class="fas fa-building me-1 text-primary"></i>
                            Department
                        </label>
                        <select class="form-select" id="department_id" name="department_id">
                            <option value="">All Departments</option>
                            {% if departments %}
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if request.args.get('department_id', '')|string == dept.id|string %}selected{% endif %}>
                                    {{ dept.department_name }}
                                </option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger w-100" id="clearFiltersBtn">
                            <i class="fas fa-redo me-1"></i> Clear Filters
                        </button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-lg-12 col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">
                                <i class="fas fa-users me-1 text-primary"></i>
                                Employees
                            </label>
                            <span class="badge bg-primary rounded-pill" id="selectedEmployeeCount">0 selected</span>
                        </div>
                        <div class="employee-selection-container">
                            <div class="mb-3 position-relative">
                                <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 10;"></i>
                                <input type="text" class="form-control ps-5" id="employee-search" placeholder="Search employees by name, fingerprint, or department..." autocomplete="off">
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label fw-bold" for="selectAll">
                                    Select All Employees
                                </label>
                            </div>
                            <hr class="my-2">
                            <div id="employee-list-container">
                                {% for user in users %}
                                {% if user.fingerprint_number and user.fingerprint_number.strip() and user.fingerprint_number|string != '1' %}
                                <div class="form-check employee-item" data-name="{{ user.get_full_name()|lower }}" data-fingerprint="{{ (user.fingerprint_number or '')|lower }}" data-department="{{ (user.department.department_name if user.department else '')|lower }}">
                                    <input class="form-check-input employee-checkbox" type="checkbox" 
                                           name="user_ids" value="{{ user.id }}" id="user_{{ user.id }}">
                                    <label class="form-check-label" for="user_{{ user.id }}">
                                        {{ user.get_full_name() }} ({{ user.fingerprint_number or 'Not Assigned' }})
                                    </label>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                Select date range and employees to generate report
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg px-4">
                                <i class="fas fa-chart-line me-2"></i>
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        <!-- Report Results - Google Sheets Style -->
        {% if all_user_reports %}
            <div class="report-card">
                <div class="report-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 d-flex align-items-center">
                                <i class="fas fa-table me-2"></i>
                                Final Report Summary
                            </h5>
                            <small class="opacity-75 d-block">
                                {% if all_user_reports %}
                                    {{ all_user_reports|length }} employee(s) â€¢ 
                                    {{ start_date.strftime('%B %d, %Y') }} - {{ end_date.strftime('%B %d, %Y') }}
                                {% else %}
                                    Select date range and employees to generate report
                                {% endif %}
                            </small>
                        </div>
                        {% if all_user_reports %}
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{{ url_for('final_report.detailed_attendance_report') }}" class="btn btn-light btn-sm">
                                <i class="fas fa-redo me-1"></i> Generate New Report
                            </a>
                            <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-download me-1"></i> Export Excel
                            </button>
                            <button class="btn btn-light btn-sm" onclick="printReport()" id="printBtn">
                                <i class="fas fa-print me-1"></i> Print
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="report-card-body p-0">
                    <!-- Google Sheets Style Table -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="finalReportTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th class="text-center" style="width: 60px;">
                                        <i class="fas fa-list me-1"></i>Details
                                    </th>
                                    <th class="text-center" style="width: 200px;">
                                        <i class="fas fa-user me-1"></i>Name
                                    </th>
                                    <th class="text-center" style="width: 150px;">
                                        <i class="fas fa-fingerprint me-1"></i>Fingerprint Number
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-building me-1"></i>Department
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar me-1"></i>Total Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-briefcase me-1"></i>Total Working Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-home me-1"></i>Day Off
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-check-circle me-1"></i>Present Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-times-circle me-1"></i>Absent Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar-check me-1"></i>Annual Leave
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar-plus me-1"></i>Paid Leave
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-user-clock me-1"></i>Permission Hours
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Incomplete Days
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-clock me-1"></i>Extra Time (hours)
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_report in all_user_reports %}
                                <tr class="employee-row" data-user-id="{{ user_report.user.id }}">
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary expand-btn" 
                                                data-user-id="{{ user_report.user.id }}" 
                                                data-start-date="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" 
                                                data-end-date="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}"
                                                title="View detailed logs">
                                            <i class="fas fa-chevron-right expand-icon"></i>
                                        </button>
                                    </td>
                                    <td class="employee-info">
                                        <div class="fw-bold text-dark">{{ user_report.user.get_full_name() }}</div>
                                    </td>
                                    <td class="text-center">
                                        <span class="fingerprint-badge">
                                            {{ user_report.user.fingerprint_number or 'Not Assigned' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="department-text">
                                            {{ user_report.user.department.department_name if user_report.user.department else 'No Department' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge total">{{ user_report.summary_metrics.total_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge working">{{ user_report.summary_metrics.total_working_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge dayoff">{{ user_report.summary_metrics.day_off_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge present">{{ user_report.summary_metrics.present_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge absent">{{ user_report.summary_metrics.absent_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge annual-leave">{{ user_report.summary_metrics.annual_leave_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge paid-leave">{{ user_report.summary_metrics.paid_leave_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge permission">{{ user_report.summary_metrics.permission_hours|default(0)|hours_minutes }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge incomplete">{{ user_report.summary_metrics.incomplete_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% set extra_time = user_report.summary_metrics.extra_time_hours|default(0) %}
                                        {% if extra_time > 0 %}
                                            <span class="badge bg-success">+{{ extra_time|hours_minutes }}</span>
                                        {% elif extra_time < 0 %}
                                            <span class="badge bg-warning">{{ extra_time|hours_minutes }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ extra_time|hours_minutes }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <!-- Expandable detailed logs row -->
                                <tr class="expandable-row" style="display: none;" data-user-id="{{ user_report.user.id }}">
                                    <td colspan="14" class="p-0">
                                        <div class="detailed-logs-container">
                                            <div class="detailed-logs-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-list me-2"></i>
                                                    Detailed Attendance Logs for {{ user_report.user.get_full_name() }}
                                                </h6>
                                            </div>
                                            <div class="detailed-logs-content">
                                                <div class="loading-spinner text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Loading attendance logs...</p>
                                                </div>
                                                <div class="logs-table-container" style="display: none;">
                                                    <table class="table table-sm table-striped mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th><i class="fas fa-calendar me-1"></i>Date</th>
                                                                <th><i class="fas fa-sign-in-alt me-1"></i>Check In</th>
                                                                <th><i class="fas fa-sign-out-alt me-1"></i>Check Out</th>
                                                                <th><i class="fas fa-clock me-1"></i>Duration</th>
                                                                <th><i class="fas fa-info-circle me-1"></i>Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="logs-tbody">
                                                            <!-- Logs will be loaded here via AJAX -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="no-logs-message text-center py-4" style="display: none;">
                                                    <i class="fas fa-info-circle text-muted mb-2"></i>
                                                    <p class="text-muted mb-0">No attendance logs found for the selected date range.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="report-card">
                <div class="report-card-body">
                    <div class="no-data-message">
                        {% if not start_date or not end_date %}
                        <i class="fas fa-calendar-alt fa-3x mb-3 text-primary"></i>
                        <h5>Select Date Range to Generate Report</h5>
                        <p class="mb-4">Please choose a start date and end date to view the attendance summary report.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Select your desired date range and choose which employees to include in the report, then click "Generate Report".
                        </div>
                        {% else %}
                        <i class="fas fa-chart-line fa-3x mb-3 text-muted"></i>
                        <h5>No Data Available</h5>
                        <p>No attendance records found for the selected date range and employees.</p>
                        {% endif %}
                        {% if error_message %}
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ error_message }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-sync indicator
let autoSyncIndicator = document.getElementById('autoSyncIndicator');

// Show auto-sync indicator on page load
window.addEventListener('load', function() {
    autoSyncIndicator.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
        autoSyncIndicator.classList.remove('show');
    }, 3000);
});

// Select all employees functionality - moved to DOMContentLoaded to avoid conflicts

// Individual checkbox change functionality - moved to main DOMContentLoaded

// Export to Excel functionality
function exportToExcel() {
    // Get parameters from URL query string (works even when form is hidden)
    const urlParams = new URLSearchParams(window.location.search);
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    const userIds = urlParams.getAll('user_ids');
    const departmentId = urlParams.get('department_id');
    
    // If not in URL, try to get from form (if visible)
    const form = document.getElementById('reportForm');
    const finalStartDate = startDate || (form ? form.querySelector('#start_date')?.value : null);
    const finalEndDate = endDate || (form ? form.querySelector('#end_date')?.value : null);
    const finalUserIds = userIds.length > 0 ? userIds : (form ? Array.from(form.querySelectorAll('input[name="user_ids"]:checked')).map(cb => cb.value) : []);
    const finalDepartmentId = departmentId || (form ? form.querySelector('#department_id')?.value : null);
    
    if (!finalStartDate || !finalEndDate) {
        alert('Please generate a report first with date range and selected employees.');
        return;
    }
    
    // Create a temporary form for export
    const exportForm = document.createElement('form');
    exportForm.method = 'GET';
    exportForm.action = '{{ url_for("final_report.export_detailed_attendance_report") }}';
    
    // Add parameters as hidden inputs
    const startInput = document.createElement('input');
    startInput.type = 'hidden';
    startInput.name = 'start_date';
    startInput.value = finalStartDate;
    exportForm.appendChild(startInput);
    
    const endInput = document.createElement('input');
    endInput.type = 'hidden';
    endInput.name = 'end_date';
    endInput.value = finalEndDate;
    exportForm.appendChild(endInput);
    
    // Add user IDs
    finalUserIds.forEach(userId => {
        const userInput = document.createElement('input');
        userInput.type = 'hidden';
        userInput.name = 'user_ids';
        userInput.value = userId;
        exportForm.appendChild(userInput);
    });
    
    // Add department ID if present
    if (finalDepartmentId) {
        const deptInput = document.createElement('input');
        deptInput.type = 'hidden';
        deptInput.name = 'department_id';
        deptInput.value = finalDepartmentId;
        exportForm.appendChild(deptInput);
    }
    
    document.body.appendChild(exportForm);
    exportForm.submit();
    document.body.removeChild(exportForm);
}

// Print report functionality
function printReport() {
    console.log('Print function called');
    
    // Check if there's data to print
    const table = document.getElementById('finalReportTable');
    const tableBody = table ? table.querySelector('tbody') : null;
    
    if (!table || !tableBody || tableBody.children.length === 0) {
        alert('No data to print. Please generate a report first.');
        console.log('No data found for printing');
        return;
    }
    
    // Get the current date range from URL or form
    const urlParams = new URLSearchParams(window.location.search);
    const form = document.getElementById('reportForm');
    const startDateInput = form ? form.querySelector('#start_date') : null;
    const endDateInput = form ? form.querySelector('#end_date') : null;
    const startDate = urlParams.get('start_date') || (startDateInput ? startDateInput.value : 'Not specified');
    const endDate = urlParams.get('end_date') || (endDateInput ? endDateInput.value : 'Not specified');
    
    console.log('Creating print window with data:', { startDate, endDate, rowCount: tableBody.children.length });
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    if (!printWindow) {
        alert('Please allow popups for this site to enable printing.');
        return;
    }
    
    // Create print content
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Final Report - ${startDate} to ${endDate}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    font-size: 12px;
                }
                h1 { 
                    color: #2c3e50; 
                    text-align: center; 
                    margin-bottom: 20px;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 10px;
                }
                .report-info {
                    background-color: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                    font-size: 11px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: center; 
                    vertical-align: middle;
                }
                th { 
                    background-color: #3498db; 
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .employee-info { text-align: left; }
                .metric-badge { 
                    display: inline-block; 
                    padding: 2px 6px; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    color: white;
                    background-color: #6c757d;
                    font-size: 10px;
                }
                .summary-row { 
                    background-color: #e9ecef; 
                    font-weight: bold; 
                }
                .summary-row td {
                    background-color: #e9ecef !important;
                }
                @media print { 
                    body { margin: 0; }
                    .no-print { display: none; }
                }
@page {
    margin: 0.5in;
    size: A4 landscape;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .final-report-container {
        padding: 1rem 0;
    }
    
    .report-header {
        padding: 1.5rem;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
    
    #finalReportTable thead th {
        font-size: 0.8rem;
        padding: 0.75rem 0.5rem;
    }
    
    #finalReportTable tbody td {
        font-size: 0.8rem;
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn {
        width: 100%;
    }
}

/* Daily grouped logs table styling */
.logs-table-container .table {
    font-size: 0.9rem;
}

.logs-table-container .table th {
    background-color: #f8f9fa;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 8px;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
    white-space: nowrap;
}

.logs-table-container .table th:last-child {
    min-width: 120px;
    white-space: nowrap;
}

.logs-table-container .table td:last-child {
    white-space: nowrap;
    min-width: 120px;
}

.logs-table-container .table td {
    padding: 10px 8px;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f4;
}

.logs-table-container .table tbody tr:hover {
    background-color: #f8f9fa;
}

.logs-table-container .badge {
    font-size: 0.75rem;
    padding: 0.4em 0.6em;
}

/* Day summary rows */
.day-summary-row {
    background-color: #ffffff;
    border-left: 4px solid #0d6efd;
    transition: all 0.2s ease;
}

.day-summary-row:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.day-summary-row td {
    border-bottom: 1px solid #e9ecef;
    font-weight: 500;
}

/* Day detail rows */
.day-detail-row {
    background-color: #f8f9fa;
    border-left: 4px solid #6c757d;
}

.day-detail-row td {
    padding: 0 !important;
    border-top: none !important;
}

/* Day logs container */
.day-logs-container {
    padding: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid #e3e6f0;
    border-radius: 12px;
    margin: 12px 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s ease;
}

.day-logs-container:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transform: translateY(-1px);
}

.day-logs-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    margin-bottom: 0;
    border-radius: 0;
    position: relative;
    overflow: hidden;
}

.day-logs-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    pointer-events: none;
}

.day-logs-header h6 {
    color: white;
    font-weight: 600;
    margin: 0;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.day-logs-content {
    padding: 20px 24px;
    background-color: #ffffff;
}

.day-logs-header .badge {
    font-size: 0.85rem;
    padding: 0.5em 0.8em;
    white-space: nowrap;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-radius: 8px;
}

.day-logs-header .badge:hover {
    background: rgba(255, 255, 255, 0.3) !important;
    transform: translateY(-1px);
}

/* Ensure proper spacing in the header */
.day-logs-header .d-flex.flex-wrap {
    min-width: 0;
    gap: 12px;
}

.day-logs-header h6 {
    flex: 1;
    min-width: 0;
}

/* Enhanced table styling */
.day-logs-content .table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 0;
}

.day-logs-content .table thead th {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: none;
    color: #495057;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 12px 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.day-logs-content .table tbody td {
    padding: 12px 16px;
    border-color: #f1f3f4;
    vertical-align: middle;
}

.day-logs-content .table tbody tr:hover {
    background-color: #f8f9ff;
    transform: scale(1.01);
    transition: all 0.2s ease;
}

/* Enhanced badge styling for logs table */
.day-logs-content .badge.bg-info {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
    min-width: 85px;
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(23, 162, 184, 0.3);
    border: none;
}

.day-logs-content .badge.bg-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
    border: none;
}

.day-logs-content .badge.bg-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
    color: #212529 !important;
    font-weight: 600;
    padding: 0.5em 0.8em;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
    border: none;
}

.day-logs-header h6 {
    margin: 0;
    color: #495057;
    font-weight: 600;
}

.day-logs-content .table {
    margin-bottom: 0;
    font-size: 0.85rem;
}

.day-logs-content .table th {
    background-color: #f1f3f4;
    font-size: 0.75rem;
    padding: 8px 6px;
}

.day-logs-content .table td {
    padding: 6px;
    font-size: 0.8rem;
}

/* Day expand button */
.day-expand-btn {
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
    border-width: 1.5px;
}

.day-expand-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.day-expand-btn.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.day-expand-btn.btn-outline-primary {
    color: #0d6efd;
    border-color: #0d6efd;
    background-color: transparent;
}

.day-expand-btn.btn-outline-primary:hover {
    background-color: #0d6efd;
    color: white;
}

.day-expand-icon {
    transition: transform 0.2s ease;
    font-size: 0.7rem;
}

.day-expand-btn.btn-primary .day-expand-icon {
    transform: rotate(90deg);
}

.day-expand-btn .day-expand-icon {
    transform: rotate(0deg);
}

/* Log type badges */
.bg-success {
    background-color: #198754 !important;
}

.bg-warning {
    background-color: #fd7e14 !important;
}

.bg-info {
    background-color: #0dcaf0 !important;
}

/* Status badges */
.badge.bg-success {
    background-color: #198754 !important;
    color: white;
}

.badge.bg-warning {
    background-color: #fd7e14 !important;
}

/* Note button styling */
.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}
.btn-purple:hover {
    background-color: #5a32a3;
    border-color: #5a32a3;
    color: white;
}

.bg-purple {
    background-color: #6f42c1 !important;
    color: white;
}
    color: white;
}

.badge.bg-danger {
    background-color: #dc3545 !important;
    color: white;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
    color: white;
}

.badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000;
}

/* Duration color coding */
.text-success.fw-bold {
    color: #198754 !important;
    font-size: 0.9rem;
}

.text-warning.fw-bold {
    color: #fd7e14 !important;
    font-size: 0.9rem;
}

.text-danger.fw-bold {
    color: #dc3545 !important;
    font-size: 0.9rem;
}

/* Duration display */
.day-summary-row td:nth-child(4) {
    font-weight: 600;
    font-size: 0.9rem;
}
            </style>
        </head>
        <body>
            <h1>Final Report Summary</h1>
            <div class="report-info">
                <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
                <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>Total Employees:</strong> ${tableBody.children.length}</p>
            </div>
            ${table.outerHTML}
        </body>
        </html>
    `;
    
    try {
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Wait for content to load before printing
        printWindow.onload = function() {
            console.log('Print window loaded, triggering print dialog');
            printWindow.focus();
            printWindow.print();
            
            // Close window after printing (with delay to allow print dialog)
            setTimeout(() => {
                printWindow.close();
            }, 1000);
        };
        
    } catch (error) {
        console.error('Error creating print window:', error);
        alert('Error creating print window. Trying alternative print method...');
        printWindow.close();
        
        // Fallback: Use browser's built-in print
        try {
            window.print();
        } catch (fallbackError) {
            console.error('Fallback print also failed:', fallbackError);
            alert('Print functionality is not available. Please use the Export Excel feature instead.');
        }
    }
}

// Auto-refresh disabled by user request
// setInterval(function() {
//     // Show auto-sync indicator
//     autoSyncIndicator.classList.add('show');
//     
//     // Refresh the page
//     setTimeout(() => {
//         window.location.reload();
//     }, 2000);
// }, 300000); // 5 minutes
console.log('ðŸ“µ Auto-refresh disabled for Final Report page');

// Clear Filters Button
document.getElementById('clearFiltersBtn')?.addEventListener('click', function() {
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    document.getElementById('department_id').value = '';
    document.getElementById('employee-search').value = '';
    
    // Uncheck all employee checkboxes
    document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    document.getElementById('selectAll').indeterminate = false;
    
    // Update employee count
    updateEmployeeCountDetailed();
    
    // Trigger employee search to show all
    document.getElementById('employee-search').dispatchEvent(new Event('input'));
});

// Update Employee Count
function updateEmployeeCountDetailed() {
    const checkedBoxes = document.querySelectorAll('.employee-checkbox:checked').length;
    const countBadge = document.getElementById('selectedEmployeeCount');
    if (countBadge) {
        countBadge.textContent = `${checkedBoxes} selected`;
        countBadge.className = checkedBoxes > 0 
            ? 'badge bg-success rounded-pill' 
            : 'badge bg-primary rounded-pill';
    }
}

// Update count when checkboxes change
document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateEmployeeCountDetailed();
    });
});

// Update count on select all
document.getElementById('selectAll')?.addEventListener('change', function() {
    updateEmployeeCountDetailed();
});

// Initial count update
updateEmployeeCountDetailed();

// Show loading state on form submission
document.getElementById('reportForm').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating Report...';
    submitBtn.disabled = true;
});

// Department filter change handler - AJAX
function setupDepartmentFilter() {
    const departmentSelect = document.getElementById('department_id');
    if (!departmentSelect) return;
    
    departmentSelect.addEventListener('change', function(e) {
        const departmentId = this.value;
        const employeeListContainer = document.getElementById('employee-list-container');
        const selectAllCheckbox = document.getElementById('selectAll');
        const employeeSearch = document.getElementById('employee-search');
        
        // Show loading state
        if (employeeListContainer) {
            employeeListContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <span class="ms-2">Loading employees...</span></div>';
        }
        
        // Fetch employees by department
        const url = new URL('{{ url_for("final_report.get_employees_by_department") }}', window.location.origin);
        if (departmentId) {
            url.searchParams.append('department_id', departmentId);
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.employees) {
                    // Clear and rebuild employee list
                    employeeListContainer.innerHTML = '';
                    
                    if (data.employees.length === 0) {
                        employeeListContainer.innerHTML = '<div class="text-muted text-center py-3">No employees found for this department.</div>';
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.indeterminate = false;
                        }
                        return;
                    }
                    
                    // Create employee items (exclude fingerprint number 1)
                    data.employees.forEach(employee => {
                        // Skip employees with fingerprint number 1
                        if (!employee.fingerprint_number || employee.fingerprint_number.toString().trim() === '1') {
                            return;
                        }
                        
                        const employeeItem = document.createElement('div');
                        employeeItem.className = 'form-check employee-item';
                        employeeItem.setAttribute('data-name', employee.full_name.toLowerCase());
                        employeeItem.setAttribute('data-fingerprint', (employee.fingerprint_number || '').toLowerCase());
                        employeeItem.setAttribute('data-department', (employee.department_name || '').toLowerCase());
                        
                        const checkboxId = `user_${employee.id}`;
                        employeeItem.innerHTML = `
                            <input class="form-check-input employee-checkbox" type="checkbox" 
                                   name="user_ids" value="${employee.id}" id="${checkboxId}">
                            <label class="form-check-label" for="${checkboxId}">
                                ${employee.full_name} (${employee.fingerprint_number})
                            </label>
                        `;
                        
                        employeeListContainer.appendChild(employeeItem);
                    });
                    
                    // Reattach checkbox event listeners
                    document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            updateSelectAllStateDetailed();
                        });
                    });
                    
                    // Update select all checkbox
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    }
                    
                    // Clear search input and reapply if there's a search term
                    if (employeeSearch && employeeSearch.value) {
                        employeeSearch.dispatchEvent(new Event('input'));
                    }
                } else {
                    employeeListContainer.innerHTML = '<div class="text-danger text-center py-3">Error loading employees. Please try again.</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching employees:', error);
                employeeListContainer.innerHTML = '<div class="text-danger text-center py-3">Error loading employees. Please try again.</div>';
            });
    });
}

// Employee search functionality
function setupEmployeeSearch() {
    const searchInput = document.getElementById('employee-search');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const employeeItems = document.querySelectorAll('.employee-item');
        
        employeeItems.forEach(item => {
            const name = item.getAttribute('data-name') || '';
            const fingerprint = item.getAttribute('data-fingerprint') || '';
            const department = item.getAttribute('data-department') || '';
            
            const matches = name.includes(searchTerm) || 
                          fingerprint.includes(searchTerm) || 
                          department.includes(searchTerm);
            
            item.style.display = matches ? '' : 'none';
        });
        
        // Update select all checkbox state based on visible checkboxes
        updateSelectAllStateDetailed();
    });
}

function updateSelectAllStateDetailed() {
    const visibleCheckboxes = Array.from(document.querySelectorAll('.employee-item:not([style*="display: none"]) .employee-checkbox'));
    const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (!selectAllCheckbox) return;
    
    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
        return;
    }
    
    if (checkedVisible.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedVisible.length === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

// Detailed Attendance Report - Enhanced debugging for expand functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Detailed Attendance Report - DOMContentLoaded fired');
    
    // Setup department filter
    setupDepartmentFilter();
    
    // Setup employee search
    setupEmployeeSearch();
    
    // Enhanced debugging for page state
    const selectAllCheckbox = document.getElementById('selectAll');
    const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
    console.log('ðŸ“‹ Found Select All checkbox:', !!selectAllCheckbox);
    console.log('ðŸ“‹ Found', employeeCheckboxes.length, 'employee checkboxes');
    
    // Select all employees functionality with proper synchronization
    if (selectAllCheckbox) {
        // Select All checkbox change handler
        selectAllCheckbox.addEventListener('change', function() {
            console.log('âœ… Select All clicked, checked:', this.checked);
            const visibleCheckboxes = document.querySelectorAll('.employee-item:not([style*="display: none"]) .employee-checkbox');
            
            // Update only visible employee checkboxes to match Select All state
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            
            // Update visual state
            this.indeterminate = false;
            
            console.log('âœ… Updated', visibleCheckboxes.length, 'visible employee checkboxes to:', this.checked);
        });
        
        // Individual checkbox change handlers for synchronization
        employeeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                console.log('ðŸ“‹ Individual checkbox changed for:', this.value);
                
                // Update Select All checkbox state based on visible checkboxes
                updateSelectAllStateDetailed();
                
                // Get all current checkboxes (in case new ones were added)
                const allCheckboxes = document.querySelectorAll('.employee-checkbox');
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
                
                console.log('ðŸ“Š Checkbox state:', {
                    allChecked: allChecked,
                    anyChecked: anyChecked,
                    totalCheckboxes: allCheckboxes.length
                });
                
                // Update Select All checkbox state
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                    console.log('âœ… All employees selected - Select All checked');
                } else if (anyChecked) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                    console.log('âš ï¸ Some employees selected - Select All indeterminate');
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                    console.log('âŒ No employees selected - Select All unchecked');
                }
            });
        });
        
        // Initial state check
        const allInitiallyChecked = Array.from(employeeCheckboxes).every(cb => cb.checked);
        const anyInitiallyChecked = Array.from(employeeCheckboxes).some(cb => cb.checked);
        
        if (allInitiallyChecked) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
            console.log('âœ… Initial state: All employees selected');
        } else if (anyInitiallyChecked) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
            console.log('âš ï¸ Initial state: Some employees selected');
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            console.log('âŒ Initial state: No employees selected');
        }
        
        console.log('âœ… Select All synchronization initialized successfully');
    } else {
        console.error('âŒ Select All checkbox not found!');
    }
    
    // Enhanced expand button functionality with comprehensive debugging
    const expandButtons = document.querySelectorAll('.expand-btn');
    const expandableRows = document.querySelectorAll('tr.expandable-row');
    
    console.log('ðŸ” Expand buttons found:', expandButtons.length);
    console.log('ðŸ” Expandable rows found:', expandableRows.length);
    
    // Debug: Log all expand buttons
    expandButtons.forEach((btn, index) => {
        console.log(`ðŸ”˜ Expand button ${index + 1}:`, {
            element: btn,
            userId: btn.getAttribute('data-user-id'),
            startDate: btn.getAttribute('data-start-date'),
            endDate: btn.getAttribute('data-end-date'),
            hasClickListener: btn.onclick !== null
        });
    });
    
    // Log all expandable rows for debugging
    expandableRows.forEach((row, index) => {
        const userId = row.getAttribute('data-user-id');
        console.log(`ðŸ“„ Expandable row ${index + 1}: User ID ${userId}`);
    });
    
    expandButtons.forEach((button, index) => {
        const userId = button.getAttribute('data-user-id');
        const startDate = button.getAttribute('data-start-date');
        const endDate = button.getAttribute('data-end-date');
        
        console.log(`ðŸ”˜ Setting up expand button ${index + 1}:`);
        console.log(`   User ID: ${userId}`);
        console.log(`   Date Range: ${startDate} to ${endDate}`);
        
        // Verify corresponding expandable row exists
        const correspondingRow = document.querySelector(`tr.expandable-row[data-user-id="${userId}"]`);
        if (!correspondingRow) {
            console.error(`âŒ No expandable row found for User ID: ${userId}`);
        } else {
            console.log(`âœ… Expandable row exists for User ID: ${userId}`);
        }
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ–±ï¸ EXPAND BUTTON CLICKED!');
            console.log('   User ID:', userId);
            console.log('   Button element:', this);
            console.log('   Event:', e);
            
            console.log('âœ… Click event is working!');
            
            // Click event is working
            
            const expandableRow = document.querySelector(`tr.expandable-row[data-user-id="${userId}"]`);
            const icon = this.querySelector('.expand-icon');
            
            // Enhanced debugging
            console.log('ðŸ” Element check:');
            console.log('   Expandable row found:', !!expandableRow);
            console.log('   Icon found:', !!icon);
            console.log('   Start date:', startDate);
            console.log('   End date:', endDate);
            
            // Element status check
            
            if (!expandableRow) {
                console.error('âŒ CRITICAL ERROR: Expandable row not found!');
                console.log('Available expandable rows:', document.querySelectorAll('tr.expandable-row'));
                console.log('Looking for user ID:', userId);
                console.log('All expandable rows:', Array.from(document.querySelectorAll('tr.expandable-row')).map(row => row.getAttribute('data-user-id')));
                return;
            }
            
            if (!icon) {
                console.error('âŒ CRITICAL ERROR: Icon not found in button!');
                return;
            }
            
            if (!startDate || !endDate) {
                console.error('âŒ CRITICAL ERROR: Missing date range!');
                alert('Error: Date range not specified. Please select dates and generate report again.');
                return;
            }
            
            const currentDisplay = expandableRow.style.display;
            const isCurrentlyHidden = currentDisplay === 'none' || currentDisplay === '';
            
            console.log('ðŸ“Š Current state:');
            console.log('   Row display:', currentDisplay);
            console.log('   Is hidden:', isCurrentlyHidden);
            
            if (isCurrentlyHidden) {
                // EXPAND THE ROW
                console.log('ðŸ“ˆ EXPANDING row for user:', userId);
                
                // Show the row first
                expandableRow.style.display = 'table-row';
                
                // Add expanded class for smooth transition
                setTimeout(() => {
                    expandableRow.classList.add('expanded');
                    this.classList.add('expanded');
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }, 10);
                
                // Check if logs need to be loaded
                const logsTbody = expandableRow.querySelector('.logs-tbody');
                const loadingSpinner = expandableRow.querySelector('.loading-spinner');
                const logsContainer = expandableRow.querySelector('.logs-table-container');
                
                console.log('ðŸ“‹ Logs elements check:');
                console.log('   Logs tbody found:', !!logsTbody);
                console.log('   Loading spinner found:', !!loadingSpinner);
                console.log('   Logs container found:', !!logsContainer);
                console.log('   Current logs count:', logsTbody ? logsTbody.children.length : 'N/A');
                
                if (logsTbody && logsTbody.children.length === 0) {
                    console.log('ðŸ”„ Loading logs for user:', userId);
                    loadEmployeeLogs(userId, startDate, endDate, expandableRow);
                } else {
                    console.log('âœ… Logs already loaded for user:', userId);
                }
            } else {
                // COLLAPSE THE ROW
                console.log('ðŸ“‰ COLLAPSING row for user:', userId);
                
                // Remove expanded class for smooth transition
                expandableRow.classList.remove('expanded');
                this.classList.remove('expanded');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
                
                // Hide after transition completes
                setTimeout(() => {
                    expandableRow.style.display = 'none';
                }, 500);
            }
        });
        
        // Enhanced hover effects
        button.addEventListener('mouseenter', function() {
            console.log('ðŸ–±ï¸ Mouse enter on expand button for user:', userId);
            this.style.transform = 'scale(1.1)';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    console.log('âœ… All expand buttons initialized successfully');
    
    // Initialize day expand listeners for dynamically created buttons
    addDayExpandListeners();
    console.log('âœ… Day expand listeners initialized');
    
    // Test API endpoint accessibility
    console.log('ðŸ§ª Testing API endpoint accessibility...');
    fetch('/detailed-attendance-report/employee-logs/1?start_date=2024-01-01&end_date=2024-01-31')
        .then(response => {
            console.log('ðŸŒ API Test Response:', response.status, response.statusText);
            return response.text();
        })
        .then(data => {
            console.log('ðŸ“Š API Test Data:', data.substring(0, 200) + '...');
        })
        .catch(error => {
            console.error('âŒ API Test Error:', error);
        });
});

function groupLogsByDate(logs) {
    const grouped = {};
    
    logs.forEach(log => {
        const date = log.date;
        if (!grouped[date]) {
            grouped[date] = [];
        }
        grouped[date].push(log);
    });
    
    // Sort logs within each date by time
    Object.keys(grouped).forEach(date => {
        grouped[date].sort((a, b) => {
            const timeA = a.time.split(':').map(Number);
            const timeB = b.time.split(':').map(Number);
            
            // Compare hours first, then minutes, then seconds
            for (let i = 0; i < 3; i++) {
                if (timeA[i] !== timeB[i]) {
                    return timeA[i] - timeB[i];
                }
            }
            return 0;
        });
    });
    
    return grouped;
}

function formatTimeToAMPM(time24) {
    // Convert 24-hour format (HH:MM:SS) to 12-hour format with AM/PM
    if (!time24) return '-';
    
    const [hours, minutes, seconds] = time24.split(':');
    const hour24 = parseInt(hours);
    const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
    const ampm = hour24 >= 12 ? 'PM' : 'AM';
    
    // Show compact format without seconds for cleaner display
    return `${hour12}:${minutes} ${ampm}`;
}

function formatDate(dateString) {
    // Format date string (YYYY-MM-DD) to readable format (Month DD, YYYY)
    if (!dateString) return '-';
    
    try {
        const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
        const months = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
    } catch (e) {
        // Fallback to original string if parsing fails
        return dateString;
    }
}

function formatHoursMinutes(decimalHours) {
    // Convert decimal hours (e.g., 3.75) to 'Xh Ym' format
    if (!decimalHours || decimalHours === 0) return '0h 0m';
    
    const isNegative = decimalHours < 0;
    const hours = Math.abs(decimalHours);
    const wholeHours = Math.floor(hours);
    const minutes = Math.floor((hours - wholeHours) * 60);
    
    let result = '';
    if (wholeHours > 0 && minutes > 0) {
        result = `${wholeHours}h ${minutes}m`;
    } else if (wholeHours > 0) {
        result = `${wholeHours}h 0m`;
    } else if (minutes > 0) {
        result = `0h ${minutes}m`;
    } else {
        result = '0h 0m';
    }
    
    return isNegative ? `-${result}` : result;
}

function addDayExpandListeners() {
    // Use event delegation to handle dynamically created buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.day-expand-btn')) {
            e.preventDefault();
            e.stopPropagation();
            
            const button = e.target.closest('.day-expand-btn');
            const date = button.getAttribute('data-date');
            const userId = button.getAttribute('data-user-id');
            // Find icon - it's an <i> tag inside the button, not necessarily with .day-expand-icon class
            const icon = button.querySelector('i.fas') || button.querySelector('i') || button.querySelector('.day-expand-icon');
            const detailRow = document.querySelector(`tr.day-detail-row[data-date="${date}"]`);
            
            console.log('ðŸ–±ï¸ Day expand button clicked for date:', date);
            console.log('   Button element:', button);
            console.log('   Detail row found:', !!detailRow);
            console.log('   Icon found:', !!icon);
            
            if (detailRow) {
                const isExpanded = detailRow.style.display !== 'none';
                console.log('   Currently expanded:', isExpanded);
                
                if (isExpanded) {
                    // Collapse
                    detailRow.style.display = 'none';
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-outline-primary');
                    console.log('ðŸ“‰ Collapsed logs for date:', date);
                } else {
                    // Expand
                    detailRow.style.display = 'table-row';
                    if (icon) {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    }
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-primary');
                    console.log('ðŸ“ˆ Expanded logs for date:', date);
                }
            } else {
                console.error('âŒ Detail row not found for date:', date);
            }
        }
    });
}

function loadEmployeeLogs(userId, startDate, endDate, expandableRow) {
    console.log('ðŸ”„ loadEmployeeLogs called with:');
    console.log('   User ID:', userId);
    console.log('   Start Date:', startDate);
    console.log('   End Date:', endDate);
    console.log('   Expandable Row:', expandableRow);
    
    // Function called successfully
    
    const loadingSpinner = expandableRow.querySelector('.loading-spinner');
    const logsTableContainer = expandableRow.querySelector('.logs-table-container');
    const noLogsMessage = expandableRow.querySelector('.no-logs-message');
    const logsTbody = expandableRow.querySelector('.logs-tbody');
    
    console.log('ðŸ” DOM elements check:');
    console.log('   Loading spinner:', !!loadingSpinner);
    console.log('   Logs table container:', !!logsTableContainer);
    console.log('   No logs message:', !!noLogsMessage);
    console.log('   Logs tbody:', !!logsTbody);
    
    if (!loadingSpinner || !logsTableContainer || !noLogsMessage || !logsTbody) {
        console.error('âŒ CRITICAL ERROR: Missing required DOM elements!');
        alert('Error: Page structure is incomplete. Please refresh and try again.');
        return;
    }
    
    // Show loading spinner
    console.log('â³ Showing loading spinner...');
    loadingSpinner.style.display = 'block';
    logsTableContainer.style.display = 'none';
    noLogsMessage.style.display = 'none';
    
    // Construct API URL
    const apiUrl = `/detailed-attendance-report/employee-logs/${userId}?start_date=${startDate}&end_date=${endDate}`;
    console.log('ðŸŒ Making AJAX request to:', apiUrl);
    
    // Make AJAX request
    fetch(apiUrl, {
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            console.log('ðŸ“¡ Response received:', response.status, response.statusText);
            console.log('ðŸ“¡ Content-Type:', response.headers.get('content-type'));
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // If not JSON, read as text to see what we got
                return response.text().then(text => {
                    console.error('âŒ Non-JSON response received:', text.substring(0, 200));
                    throw new Error(`Server returned HTML instead of JSON. This usually means an authentication or permission error. Status: ${response.status}`);
                });
            }
            
            if (!response.ok) {
                // For error responses, try to parse JSON error message
                return response.json().then(errorData => {
                    // Create error with detailed message from server
                    const errorMessage = errorData.message || errorData.error || `HTTP ${response.status}: ${response.statusText}`;
                    const error = new Error(errorMessage);
                    error.status = response.status;
                    error.errorData = errorData; // Attach full error data
                    throw error;
                }).catch(parseError => {
                    // If JSON parsing fails, throw generic error
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('ðŸ“Š Data received:', data);
            loadingSpinner.style.display = 'none';
            
            // Check if request was successful
            if (data.success === false) {
                console.error('âŒ API returned error:', data.error || data.message);
                noLogsMessage.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-danger mb-2"></i>
                        <p class="text-danger mb-0">Error loading attendance logs.</p>
                        <small class="text-muted">${data.error || data.message || 'Unknown error'}</small><br>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadEmployeeLogs('${userId}', '${startDate}', '${endDate}', this.closest('tr'))">
                            <i class="fas fa-redo me-1"></i> Retry
                        </button>
                    </div>
                `;
                noLogsMessage.style.display = 'block';
                return;
            }
            
            if (data.success && data.daily_data && data.daily_data.length > 0) {
                console.log('âœ… Found', data.daily_data.length, 'days for user', userId);
                
                // Show all days in the date range with their correct statuses
                logsTbody.innerHTML = '';
                data.daily_data.forEach(dayData => {
                    console.log(`ðŸ“… Processing date ${dayData.date}:`, dayData);
                    
                    // Format time display
                    const checkInTime = dayData.check_in ? formatTimeToAMPM(dayData.check_in) : null;
                    const checkOutTime = dayData.check_out ? formatTimeToAMPM(dayData.check_out) : null;
                    
                    // Format duration - use raw_hours_worked for numeric calculations
                    let duration = '-';
                    const hoursWorkedNum = dayData.raw_hours_worked || (typeof dayData.hours_worked === 'number' ? dayData.hours_worked : 0);
                    if (hoursWorkedNum > 0) {
                        const hours = Math.floor(hoursWorkedNum);
                        const minutes = Math.floor((hoursWorkedNum - hours) * 60);
                        
                        if (hours > 0) {
                            duration = `${hours}h ${minutes}m`;
                        } else {
                            duration = `${minutes}m`;
                        }
                        
                        // Add color coding based on duration
                        if (hours >= 8) {
                            duration = `<span class="text-success fw-bold">${duration}</span>`;
                        } else if (hours >= 6) {
                            duration = `<span class="text-warning fw-bold">${duration}</span>`;
                        } else {
                            duration = `<span class="text-danger fw-bold">${duration}</span>`;
                        }
                    }
                    
                    // Format status with appropriate badge based on precise status string
                    let status = '';
                    const statusText = dayData.status;

                    if (statusText === 'Present') {
                        status = '<span class="badge bg-success">Present</span>';
                    } else if (statusText === 'Absent') {
                        status = '<span class="badge bg-danger">Absent</span>';
                    } else if (statusText === 'Incomplete') {
                        status = '<span class="badge bg-warning">Incomplete</span>';
                    } else if (statusText === 'Paid Leave' || statusText.includes('Holiday')) {
                        status = '<span class="badge bg-info">Paid Leave</span>';
                    } else if (statusText === 'Annual Leave' || statusText === 'Sick Leave') {
                        status = '<span class="badge bg-primary">' + statusText + '</span>';
                    } else if (statusText === 'Day Off') {
                        status = '<span class="badge bg-secondary">Day Off</span>';
                    } else if (statusText.includes('Present /')) {
                        status = '<span class="badge bg-success">' + statusText + '</span>';
                    } else if (statusText === 'Permission') {
                        status = '<span class="badge bg-info">Permission</span>';
                    } else {
                        // Default for other statuses or unknown
                        status = '<span class="badge bg-secondary">' + statusText + '</span>';
                    }
                    
                    // Create main day row
                    const dayRow = document.createElement('tr');
                    dayRow.className = 'day-summary-row';
                    dayRow.setAttribute('data-date', dayData.date);
                    dayRow.innerHTML = `
                        <td class="fw-bold text-primary">${dayData.date}</td>
                        <td>
                            ${checkInTime ? 
                                `<span class="badge bg-success">${checkInTime}</span>` : 
                                '<span class="text-muted">-</span>'
                            }
                        </td>
                        <td>
                            ${checkOutTime ? 
                                `<span class="badge bg-warning">${checkOutTime}</span>` : 
                                '<span class="text-muted">-</span>'
                            }
                        </td>
                        <td>${duration}</td>
                        <td>${status}</td>
                        <td style="white-space: nowrap; min-width: 120px;">
                            <button class="btn btn-sm btn-outline-primary day-expand-btn" 
                                    data-date="${dayData.date}" 
                                    data-user-id="${userId}"
                                    data-bs-toggle="collapse" data-bs-target="#logs-${userId}-${dayData.date}" 
                                    aria-expanded="false" aria-controls="logs-${userId}-${dayData.date}"
                                    style="white-space: nowrap;">
                                <i class="fas fa-chevron-down"></i> ${(dayData.logs || dayData.all_logs || []).length} Logs
                            </button>
                            ${dayData.notes && dayData.notes.length > 0 ? dayData.notes.map((note, idx) => `
                                <button type="button" class="btn btn-sm btn-purple ms-1" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#noteModal${userId}-${dayData.date}-${note.id}"
                                        title="View Note">
                                    <i class="fas fa-sticky-note me-1"></i>Note
                                </button>
                            `).join('') : ''}
                        </td>
                    `;
                    logsTbody.appendChild(dayRow);
                    
                    // Create expandable detail row
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'day-detail-row';
                    detailRow.setAttribute('data-date', dayData.date);
                    detailRow.style.display = 'none';
                    
                    // Use extra time from the calculated data - prefer formatted version if available
                    let extraTimeDisplay = '-';
                    if (dayData.extra_time !== 0 || (dayData.extra_time_formatted && dayData.extra_time_formatted !== '0h 0m')) {
                        if (dayData.extra_time_formatted) {
                            // Use pre-formatted version from backend
                            extraTimeDisplay = (dayData.extra_time > 0 ? '+' : '') + dayData.extra_time_formatted;
                        } else {
                            // Fallback: format in JavaScript if not provided
                            const formatExtraTime = (hours) => {
                                if (hours === 0) return "0h 0m";
                                
                                const isNegative = hours < 0;
                                hours = Math.abs(hours);
                                
                                const wholeHours = Math.floor(hours);
                                const minutes = Math.floor((hours - wholeHours) * 60);
                                
                                let result;
                                if (wholeHours > 0 && minutes > 0) {
                                    result = `${wholeHours}h ${minutes}m`;
                                } else if (wholeHours > 0) {
                                    result = `${wholeHours}h 0m`;
                                } else if (minutes > 0) {
                                    result = `0h ${minutes}m`;
                                } else {
                                    result = "0h 0m";
                                }
                                
                                return isNegative ? `-${result}` : (dayData.extra_time > 0 ? `+${result}` : result);
                            };
                            
                            extraTimeDisplay = formatExtraTime(dayData.extra_time);
                        }
                    }
                    
                    console.log('ðŸ“ Creating detail row for date:', dayData.date);
                    detailRow.innerHTML = `
                        <td colspan="6" class="p-0">
                            <div class="day-logs-container">
                                <div class="day-logs-header">
                                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-list me-2"></i>
                                            All logs for ${dayData.date} (${(dayData.all_logs || []).length} entries)
                                        </h6>
                                        <div class="log-summary-badges d-flex align-items-center">
                                            <span class="badge badge-light-primary me-2 total-hours-badge">
                                                <i class="ki-duotone ki-time fs-4 me-1"></i>
                                                Total: ${(dayData.raw_hours_worked || (typeof dayData.hours_worked === 'number' ? dayData.hours_worked : 0)) > 0 ? formatHoursMinutes(dayData.raw_hours_worked || dayData.hours_worked || 0) : '-'}
                                            </span>
                                            <span class="badge badge-light-info extra-time-badge">
                                                <i class="ki-duotone ki-hourglass-2 fs-4 me-1"></i>
                                                Extra: ${extraTimeDisplay}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="day-logs-content">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Time</th>
                                                <th>Type</th>
                                                <th>Duration from Previous</th>
                                            </tr>
                                        </thead>
                                        <tbody class="day-logs-tbody">
                                            ${(() => {
                                                // Sort logs chronologically (oldest first) to ensure proper duration calculation
                                                const logs = (dayData.logs || dayData.all_logs || []).slice();
                                                logs.sort((a, b) => {
                                                    const timeA = a.time || (a.timestamp ? a.timestamp.split(' ')[1] : '00:00:00');
                                                    const timeB = b.time || (b.timestamp ? b.timestamp.split(' ')[1] : '00:00:00');
                                                    return timeA.localeCompare(timeB);
                                                });
                                                
                                                return logs.map((log, index, logsArray) => {
                                                    let durationFromPrevious = '-';
                                                    if (index > 0 && logsArray[index - 1]) {
                                                        try {
                                                            const prevTimeStr = logsArray[index - 1].time || (logsArray[index - 1].timestamp ? logsArray[index - 1].timestamp.split(' ')[1] : '');
                                                            const currentTimeStr = log.time || (log.timestamp ? log.timestamp.split(' ')[1] : '');
                                                            
                                                            if (prevTimeStr && currentTimeStr) {
                                                                const prevTime = new Date(`${dayData.date} ${prevTimeStr}`);
                                                                const currentTime = new Date(`${dayData.date} ${currentTimeStr}`);
                                                                const diffMs = currentTime - prevTime;
                                                                if (diffMs > 0 && !isNaN(diffMs)) {
                                                                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                                                                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                                                    if (hours > 0) {
                                                                        durationFromPrevious = `${hours}h ${minutes}m`;
                                                                    } else if (minutes > 0) {
                                                                        durationFromPrevious = `${minutes}m`;
                                                                    } else {
                                                                        const seconds = Math.floor(diffMs / 1000);
                                                                        if (seconds > 0) {
                                                                            durationFromPrevious = `${seconds}s`;
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        } catch (e) {
                                                            console.warn('Error calculating duration from previous:', e);
                                                        }
                                                    }
                                                
                                                    const logTime = log.time || (log.timestamp ? log.timestamp.split(' ')[1] : '');
                                                    
                                                    // Always use position-based logic: first = check-in, last = check-out
                                                    let scanTypeLabel = '';
                                                    let badgeClass = 'bg-secondary';
                                                    
                                                    if (index === 0) {
                                                        scanTypeLabel = 'Check In';
                                                        badgeClass = 'bg-success';
                                                    } else if (index === logsArray.length - 1) {
                                                        scanTypeLabel = 'Check Out';
                                                        badgeClass = 'bg-danger';
                                                    } else {
                                                        scanTypeLabel = 'Additional';
                                                        badgeClass = 'bg-secondary';
                                                    }
                                                    
                                                    return `
                                                        <tr>
                                                            <td><span class="badge bg-info">${logTime ? formatTimeToAMPM(logTime) : '-'}</span></td>
                                                            <td>
                                                                <span class="badge ${badgeClass}">${scanTypeLabel}</span>
                                                            </td>
                                                            <td class="fw-bold">${durationFromPrevious}</td>
                                                        </tr>
                                                    `;
                                                }).join('');
                                            })()}
                                        </tbody>
                                    </table>
                                    
                                    ${dayData.permission_request ? `
                                        <div class="permission-request-section mt-3 p-3 bg-light rounded">
                                            <h6 class="mb-2">
                                                <i class="fas fa-user-clock me-2 text-primary"></i>
                                                Permission Request
                                            </h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="permission-detail">
                                                        <strong>Time:</strong> 
                                                        <span class="badge bg-primary">${formatTimeToAMPM(dayData.permission_request.start_time)}</span> 
                                                        to 
                                                        <span class="badge bg-primary">${formatTimeToAMPM(dayData.permission_request.end_time)}</span>
                                                    </div>
                                                    <div class="permission-detail mt-1">
                                                        <strong>Duration:</strong> 
                                                        <span class="badge bg-info">${dayData.permission_request.duration_hours}h</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="permission-detail">
                                                        <strong>Status:</strong> 
                                                        <span class="badge ${dayData.permission_request.status === 'approved' ? 'bg-success' : 'bg-warning'}">${dayData.permission_request.status}</span>
                                                    </div>
                                                    <div class="permission-detail mt-1">
                                                        <strong>Reason:</strong> 
                                                        <span class="text-muted">${dayData.permission_request.reason || 'No reason provided'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${dayData.notes && dayData.notes.length > 0 ? `
                                        ${dayData.notes.map((note, idx) => `
                                            <div class="note-section mt-3 p-3 bg-light rounded">
                                                <h6 class="mb-2">
                                                    <i class="fas fa-sticky-note me-2 text-purple"></i>
                                                    Note ${idx + 1}
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="note-detail">
                                                            <strong>Date Range:</strong>
                                                            ${note.start_date === note.end_date ? 
                                                                `<span class="badge bg-purple">${formatDate(note.start_date)}</span>` :
                                                                `<span class="badge bg-purple">${formatDate(note.start_date)} - ${formatDate(note.end_date)}</span>`
                                                            }
                                                        </div>
                                                        <div class="note-detail mt-2">
                                                            <strong>Comment:</strong>
                                                            <p class="text-muted mt-1">${note.comment || 'No comment'}</p>
                                                        </div>
                                                        <div class="note-detail mt-2">
                                                            <strong>Created By:</strong>
                                                            <span class="text-muted">${note.created_by_name || 'Unknown'}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    ` : ''}
                                </div>
                            </div>
                        </td>
                    `;
                    logsTbody.appendChild(detailRow);
                    
                    // Create note modals for this day
                    if (dayData.notes && dayData.notes.length > 0) {
                        dayData.notes.forEach((note, idx) => {
                            const modalId = `noteModal${userId}-${dayData.date}-${note.id}`;
                            // Check if modal already exists
                            if (!document.getElementById(modalId)) {
                                const modal = document.createElement('div');
                                modal.className = 'modal fade';
                                modal.id = modalId;
                                modal.setAttribute('tabindex', '-1');
                                modal.setAttribute('aria-labelledby', `noteModalLabel${userId}-${dayData.date}-${note.id}`);
                                modal.setAttribute('aria-hidden', 'true');
                                modal.innerHTML = `
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="noteModalLabel${userId}-${dayData.date}-${note.id}">
                                                    <i class="fas fa-sticky-note me-2"></i>Note Details
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Date Range</label>
                                                    <div class="form-control-plaintext">
                                                        ${note.start_date === note.end_date ? 
                                                            `<i class="fas fa-calendar me-2"></i>${formatDate(note.start_date)}` :
                                                            `<i class="fas fa-calendar me-2"></i>${formatDate(note.start_date)} - ${formatDate(note.end_date)}`
                                                        }
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Comment</label>
                                                    <div class="form-control-plaintext" style="white-space: pre-wrap;">${note.comment || 'No comment'}</div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label fw-bold">Created By</label>
                                                        <div class="form-control-plaintext">
                                                            ${note.created_by_name || 'Unknown'}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label fw-bold">Created At</label>
                                                        <div class="form-control-plaintext">
                                                            ${note.created_at || 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(modal);
                            }
                        });
                    }
                    
                    console.log('âœ… Detail row created and appended for date:', dayData.date);
                    console.log('   Detail row element:', detailRow);
                });
                
                console.log('ðŸ“‹ Showing daily grouped logs with expand functionality...');
                logsTableContainer.style.display = 'block';
            } else {
                console.log('â„¹ï¸ No logs found for user', userId);
                console.log('   Data success:', data.success);
                console.log('   Logs array:', data.logs);
                
                // Show no logs message
                noLogsMessage.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle text-muted mb-2"></i>
                        <p class="text-muted mb-0">No attendance logs found for the selected date range.</p>
                        <small class="text-muted">Date range: ${startDate} to ${endDate}</small>
                    </div>
                `;
                noLogsMessage.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('âŒ AJAX Error loading employee logs:', error);
            console.error('   Error details:', {
                message: error.message,
                status: error.status,
                errorData: error.errorData,
                stack: error.stack,
                userId: userId,
                dateRange: `${startDate} to ${endDate}`,
                apiUrl: apiUrl
            });
            
            loadingSpinner.style.display = 'none';
            
            // Extract error message - prefer server message if available
            let errorMessage = error.message;
            if (error.errorData) {
                errorMessage = error.errorData.message || error.errorData.error || errorMessage;
            }
            
            // Special handling for 403 Forbidden
            if (error.status === 403) {
                errorMessage = error.errorData?.message || error.errorData?.error || 'You do not have permission to view this employee\'s attendance logs.';
            }
            
            noLogsMessage.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-danger mb-2"></i>
                    <p class="text-danger mb-0">Error loading attendance logs.</p>
                    <small class="text-muted">${errorMessage}</small><br>
                    ${error.status !== 403 ? `<button class="btn btn-sm btn-outline-primary mt-2" onclick="loadEmployeeLogs('${userId}', '${startDate}', '${endDate}', this.closest('tr'))">
                        <i class="fas fa-redo me-1"></i> Retry
                    </button>` : ''}
                </div>
            `;
            noLogsMessage.style.display = 'block';
        });
}
</script>
{% endblock %}
