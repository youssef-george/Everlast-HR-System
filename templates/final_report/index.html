{% extends 'layout.html' %}

{% block content %}
<style>
/* Final Report specific styling */
.final-report-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 2rem 0;
    position: relative;
    overflow-x: hidden;
}

.final-report-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(0,0,0,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.5;
    pointer-events: none;
}

/* Page Title Styling */
.page-title {
    color: #2c3e50;
    font-weight: 800;
    font-size: 3rem;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.8s ease;
}

.page-subtitle {
    color: #6c757d;
    font-size: 1.2rem;
    margin-bottom: 2rem;
    position: relative;
    z-index: 2;
    animation: fadeInUp 0.8s ease 0.2s both;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.report-header {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    padding: 2.5rem;
    border: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.report-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    overflow: hidden;
    border: 1px solid #e9ecef;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.report-card-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 1.5rem;
    border: none;
}

.report-card-body {
    padding: 0;
}

.metric-card {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-present {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.status-absent {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
}

.status-leave {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
    color: white;
}

.status-permission {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
}

.employee-selection-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.9);
}

.filter-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
}

.auto-sync-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    font-size: 0.9rem;
    font-weight: 600;
    display: none;
}

.auto-sync-indicator.show {
    display: block;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.table-responsive {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.table th {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.8rem;
}

.table td {
    border: none;
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.table tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: rgba(52, 73, 94, 0.05);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.no-data-message {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-size: 1.1rem;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2c3e50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Google Sheets Style Table */
#finalReportTable {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    border-collapse: separate;
    border-spacing: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

#finalReportTable thead th {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 1.25rem 0.75rem;
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    vertical-align: middle;
    text-align: center;
    border-bottom: 3px solid #1a252f;
}

#finalReportTable thead th i {
    margin-right: 0.5rem;
    font-size: 0.8rem;
    opacity: 0.9;
}

#finalReportTable tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid #f0f0f0;
    background: white;
}

#finalReportTable tbody tr:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #2c3e50;
}

#finalReportTable tbody tr:nth-child(even) {
    background: #fafbfc;
}

#finalReportTable tbody tr:nth-child(even):hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

#finalReportTable tbody td {
    padding: 1.25rem 0.75rem;
    vertical-align: middle;
    border: none;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
}

#finalReportTable tbody td:first-child {
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
}

#finalReportTable tfoot tr {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border-top: 4px solid #1a252f;
    color: white;
}

#finalReportTable tfoot td {
    padding: 1.5rem 0.75rem;
    font-weight: 800;
    font-size: 1.1rem;
    border: none;
    text-align: center;
    vertical-align: middle;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

#finalReportTable tfoot td:first-child {
    text-align: left;
    font-weight: 800;
}

/* Employee Info Styling */
.employee-info {
    min-width: 200px;
}

.employee-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Fingerprint Badge */
.fingerprint-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

/* Department Text */
.department-text {
    display: inline-block;
    font-weight: 500;
    font-size: 0.9rem;
    color: #495057;
    text-align: center;
    padding: 0.25rem 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    min-width: 100px;
}

/* Modern Button Styling */
.btn {
    border-radius: 12px;
    font-weight: 700;
    padding: 0.875rem 2rem;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-size: 0.9rem;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border: none;
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
}

.btn-outline-light {
    border: 2px solid #2c3e50;
    color: #2c3e50;
    background: transparent;
}

.btn-outline-light:hover {
    background: #2c3e50;
    color: white;
    border-color: #2c3e50;
}

.btn-light {
    background: rgba(255, 255, 255, 0.9);
    color: #2c3e50;
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-weight: 600;
}

.btn-light:hover {
    background: white;
    color: #2c3e50;
    border-color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Metric Badges */
.metric-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    min-width: 40px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.metric-badge.present {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.absent {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.annual-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}


.metric-badge.unpaid-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.paid-leave {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.permission {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.working {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.total {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

.metric-badge.dayoff {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
}

/* Extra Time Badge Styling */
.badge.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
}

.badge.bg-warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
}

.badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
    color: white;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    border-radius: 15px;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
}

.metric-badge.summary {
    background: linear-gradient(135deg, #212529 0%, #495057 100%);
    color: white;
    font-size: 1rem;
    padding: 0.75rem 1.25rem;
}

/* Attendance Percentage */
.attendance-percentage {
    font-weight: 700;
    font-size: 1.1rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    color: white;
    display: inline-block;
    min-width: 60px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.attendance-percentage.summary {
    background: linear-gradient(135deg, #212529 0%, #495057 100%);
    font-size: 1.2rem;
    padding: 0.75rem 1.25rem;
}

/* Sticky Header */
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

/* Table Responsive Enhancements */
.table-responsive {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
}

/* Remove white space and improve table layout */
#finalReportTable {
    width: 100%;
    table-layout: fixed;
    min-width: 1200px;
}

.report-card-body {
    padding: 0 !important;
    overflow-x: auto;
}

/* Ensure table fills container */
.final-report-container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 1rem;
}

.report-card {
    width: 100%;
    margin: 0;
}

/* Print Styles */
@media print {
    .final-report-container {
        background: white !important;
    }
    
    .report-header {
        background: white !important;
        box-shadow: none !important;
    }
    
    .filter-section {
        display: none !important;
    }
    
    #finalReportTable {
        box-shadow: none !important;
    }
    
    #finalReportTable thead th {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    #finalReportTable tbody tr {
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .metric-badge {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .attendance-percentage {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #dee2e6 !important;
    }
}

/* Remove excessive white space */
.container-fluid {
    padding: 0;
    margin: 0;
    max-width: 100%;
}

.final-report-container {
    padding: 0.5rem;
    margin: 0;
    max-width: 100%;
}

.report-card {
    margin-bottom: 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Ensure table takes full width */
.table-responsive {
    width: 100%;
    margin: 0;
    padding: 0;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .final-report-container {
        padding: 0.25rem;
    }
    
    .report-header {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
    
    #finalReportTable thead th,
    #finalReportTable tbody td {
        padding: 0.5rem 0.25rem;
    }
    
    .metric-badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        min-width: 30px;
    }
    
    .attendance-percentage {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        min-width: 50px;
    }
    
    .employee-info {
        min-width: 150px;
    }
    
    .employee-avatar {
        width: 30px;
        height: 30px;
    }
}
</style>

<div class="final-report-container">
    <!-- Auto-sync indicator -->
    <div id="autoSyncIndicator" class="auto-sync-indicator">
        <i class="fas fa-sync-alt me-2"></i>
        <span>Auto-syncing data...</span>
    </div>

    <div class="container-fluid">
        <!-- Report Header -->
        <div class="report-header">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="page-title mb-2">
                        <i class="fas fa-chart-line me-2"></i>
                        Final Report
                    </h1>
                    <p class="page-subtitle mb-0">Comprehensive attendance report with duplicate removal and auto-sync</p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Final Report</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filter-section">
            <h5 class="mb-3">
                <i class="fas fa-filter me-2"></i>
                Report Filters
            </h5>
            <form method="GET" action="{{ url_for('final_report.final_report') }}" id="reportForm">
                <div class="row mb-3">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" required>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <label for="end_date" class="form-label">End Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" required>
                    </div>
                    {% if current_user.role != 'employee' %}
                    <div class="col-lg-6 col-md-12">
                        <label class="form-label">Employees</label>
                        <div class="employee-selection-container">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="employee-search" placeholder="Search employees by name, fingerprint, or department..." autocomplete="off">
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAll" checked>
                                <label class="form-check-label fw-bold" for="selectAll">
                                    Select All Employees
                                </label>
                            </div>
                            <hr class="my-2">
                            <div id="employee-list-container">
                                {% for user in users %}
                                <div class="form-check employee-item" data-name="{{ user.get_full_name()|lower }}" data-fingerprint="{{ (user.fingerprint_number or '')|lower }}" data-department="{{ (user.department.department_name if user.department else '')|lower }}">
                                    <input class="form-check-input employee-checkbox" type="checkbox" 
                                           name="user_ids" value="{{ user.id }}" id="user_{{ user.id }}" checked>
                                    <label class="form-check-label" for="user_{{ user.id }}">
                                        {{ user.get_full_name() }} ({{ user.fingerprint_number or 'Not Assigned' }})
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- For employees, automatically select themselves -->
                    <input type="hidden" name="user_ids" value="{{ current_user.id }}">
                    {% endif %}
                </div>
                <div class="row">
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Report Results - Google Sheets Style -->
        {% if all_user_reports %}
            <div class="report-card">
                <div class="report-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 d-flex align-items-center">
                                <i class="fas fa-table me-2"></i>
                                Final Report Summary
                            </h5>
                            <small class="opacity-75 d-block">
                                {% if all_user_reports %}
                                    {{ all_user_reports|length }} employee(s) â€¢ 
                                    {{ start_date.strftime('%B %d, %Y') }} - {{ end_date.strftime('%B %d, %Y') }}
                                {% else %}
                                    Select date range and employees to generate report
                                {% endif %}
                            </small>
                        </div>
                        {% if all_user_reports %}
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                                <i class="fas fa-download me-1"></i> Export Excel
                            </button>
                            <button class="btn btn-light btn-sm" onclick="printReport()" id="printBtn">
                                <i class="fas fa-print me-1"></i> Print
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="report-card-body p-0">
                    <!-- Google Sheets Style Table -->
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="finalReportTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th class="text-center" style="width: 200px;">
                                        <i class="fas fa-user me-1"></i>Name
                                    </th>
                                    <th class="text-center" style="width: 150px;">
                                        <i class="fas fa-fingerprint me-1"></i>Fingerprint Number
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-building me-1"></i>Department
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar me-1"></i>Total Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-briefcase me-1"></i>Total Working Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-home me-1"></i>Day Off
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-check-circle me-1"></i>Present Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-times-circle me-1"></i>Absent Days
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar-check me-1"></i>Annual Leave
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-calendar-plus me-1"></i>Paid Leave
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-user-clock me-1"></i>Permission Hours
                                    </th>
                                    <th class="text-center" style="width: 100px;">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Incomplete Days
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-clock me-1"></i>Extra Time (hours)
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_report in all_user_reports %}
                                <tr class="employee-row">
                                    <td class="employee-info">
                                        <div class="fw-bold text-dark">{{ user_report.user.get_full_name() }}</div>
                                    </td>
                                    <td class="text-center">
                                        <span class="fingerprint-badge">
                                            {{ user_report.user.fingerprint_number or 'Not Assigned' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="department-text">
                                            {{ user_report.user.department.department_name if user_report.user.department else 'No Department' }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge total">{{ user_report.summary_metrics.total_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge working">{{ user_report.summary_metrics.total_working_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge dayoff">{{ user_report.summary_metrics.day_off_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge present">{{ user_report.summary_metrics.present_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge absent">{{ user_report.summary_metrics.absent_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge annual-leave">{{ user_report.summary_metrics.annual_leave_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge paid-leave">{{ user_report.summary_metrics.paid_leave_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge permission">{{ user_report.summary_metrics.permission_hours|default(0)|hours_minutes }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="metric-badge incomplete">{{ user_report.summary_metrics.incomplete_days|default(0) }}</span>
                                    </td>
                                    <td class="text-center">
                                        {% set extra_time = user_report.summary_metrics.extra_time_hours|default(0) %}
                                        {% if extra_time > 0 %}
                                            <span class="badge bg-success">+{{ extra_time|hours_minutes }}</span>
                                        {% elif extra_time < 0 %}
                                            <span class="badge bg-warning">{{ extra_time|hours_minutes }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ extra_time|hours_minutes }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="report-card">
                <div class="report-card-body">
                    <div class="no-data-message">
                        {% if not start_date or not end_date %}
                        <i class="fas fa-calendar-alt fa-3x mb-3 text-primary"></i>
                        <h5>Select Date Range to Generate Report</h5>
                        <p class="mb-4">Please choose a start date and end date to view the attendance summary report.</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Select your desired date range and choose which employees to include in the report, then click "Generate Report".
                        </div>
                        {% else %}
                        <i class="fas fa-chart-line fa-3x mb-3 text-muted"></i>
                        <h5>No Data Available</h5>
                        <p>No attendance records found for the selected date range and employees.</p>
                        {% endif %}
                        {% if error_message %}
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ error_message }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-sync indicator
let autoSyncIndicator = document.getElementById('autoSyncIndicator');

// Show auto-sync indicator on page load
window.addEventListener('load', function() {
    autoSyncIndicator.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
        autoSyncIndicator.classList.remove('show');
    }, 3000);
});

// Employee search functionality
document.getElementById('employee-search')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    const employeeItems = document.querySelectorAll('.employee-item');
    
    employeeItems.forEach(item => {
        const name = item.getAttribute('data-name') || '';
        const fingerprint = item.getAttribute('data-fingerprint') || '';
        const department = item.getAttribute('data-department') || '';
        
        const matches = name.includes(searchTerm) || 
                      fingerprint.includes(searchTerm) || 
                      department.includes(searchTerm);
        
        item.style.display = matches ? '' : 'none';
    });
    
    // Update select all checkbox state based on visible checkboxes
    updateSelectAllState();
});

function updateSelectAllState() {
    const visibleCheckboxes = Array.from(document.querySelectorAll('.employee-item:not([style*="display: none"]) .employee-checkbox'));
    const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
        return;
    }
    
    if (checkedVisible.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedVisible.length === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

// Select all employees functionality
document.getElementById('selectAll')?.addEventListener('change', function() {
    const visibleCheckboxes = document.querySelectorAll('.employee-item:not([style*="display: none"]) .employee-checkbox');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Update select all state when individual checkboxes change
document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectAllState);
});

// Export to Excel functionality
function exportToExcel() {
    const form = document.getElementById('reportForm');
    const formData = new FormData(form);
    formData.append('format', 'excel');
    
    // Create a temporary form for export
    const exportForm = document.createElement('form');
    exportForm.method = 'GET';
    exportForm.action = '{{ url_for("final_report.export_final_report") }}';
    
    // Add all form data as hidden inputs
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        exportForm.appendChild(input);
    }
    
    document.body.appendChild(exportForm);
    exportForm.submit();
    document.body.removeChild(exportForm);
}

// Print report functionality
function printReport() {
    console.log('Print function called');
    
    // Check if there's data to print
    const table = document.getElementById('finalReportTable');
    const tableBody = table ? table.querySelector('tbody') : null;
    
    if (!table || !tableBody || tableBody.children.length === 0) {
        alert('No data to print. Please generate a report first.');
        console.log('No data found for printing');
        return;
    }
    
    // Get the current date range
    const startDate = document.getElementById('start_date').value || 'Not specified';
    const endDate = document.getElementById('end_date').value || 'Not specified';
    
    console.log('Creating print window with data:', { startDate, endDate, rowCount: tableBody.children.length });
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    if (!printWindow) {
        alert('Please allow popups for this site to enable printing.');
        return;
    }
    
    // Create print content
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Final Report - ${startDate} to ${endDate}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    font-size: 12px;
                }
                h1 { 
                    color: #2c3e50; 
                    text-align: center; 
                    margin-bottom: 20px;
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 10px;
                }
                .report-info {
                    background-color: #f8f9fa;
                    padding: 15px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 20px;
                    font-size: 11px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: center; 
                    vertical-align: middle;
                }
                th { 
                    background-color: #3498db; 
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                .employee-info { text-align: left; }
                .metric-badge { 
                    display: inline-block; 
                    padding: 2px 6px; 
                    border-radius: 8px; 
                    font-weight: bold; 
                    color: white;
                    background-color: #6c757d;
                    font-size: 10px;
                }
                .summary-row { 
                    background-color: #e9ecef; 
                    font-weight: bold; 
                }
                .summary-row td {
                    background-color: #e9ecef !important;
                }
                @media print { 
                    body { margin: 0; }
                    .no-print { display: none; }
                }
@page {
    margin: 0.5in;
    size: A4 landscape;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .final-report-container {
        padding: 1rem 0;
    }
    
    .report-header {
        padding: 1.5rem;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
    }
    
    #finalReportTable thead th {
        font-size: 0.8rem;
        padding: 0.75rem 0.5rem;
    }
    
    #finalReportTable tbody td {
        font-size: 0.8rem;
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .btn {
        width: 100%;
    }
}
            </style>
        </head>
        <body>
            <h1>Final Report Summary</h1>
            <div class="report-info">
                <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
                <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>Total Employees:</strong> ${tableBody.children.length}</p>
            </div>
            ${table.outerHTML}
        </body>
        </html>
    `;
    
    try {
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Wait for content to load before printing
        printWindow.onload = function() {
            console.log('Print window loaded, triggering print dialog');
            printWindow.focus();
            printWindow.print();
            
            // Close window after printing (with delay to allow print dialog)
            setTimeout(() => {
                printWindow.close();
            }, 1000);
        };
        
    } catch (error) {
        console.error('Error creating print window:', error);
        alert('Error creating print window. Trying alternative print method...');
        printWindow.close();
        
        // Fallback: Use browser's built-in print
        try {
            window.print();
        } catch (fallbackError) {
            console.error('Fallback print also failed:', fallbackError);
            alert('Print functionality is not available. Please use the Export Excel feature instead.');
        }
    }
}

// Auto-refresh disabled by user request
// setInterval(function() {
//     // Show auto-sync indicator
//     autoSyncIndicator.classList.add('show');
//     
//     // Refresh the page
//     setTimeout(() => {
//         window.location.reload();
//     }, 2000);
// }, 300000); // 5 minutes
console.log('ðŸ“µ Auto-refresh disabled for Final Report page');

// Show loading state on form submission
document.getElementById('reportForm').addEventListener('submit', function() {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="loading-spinner me-2"></span>Generating Report...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}
