{% extends "layout.html" %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">{{ 'Create Leave Request' if not is_edit else 'Edit Leave Request' }}</h1>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Leave Request Details</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('leave.create') if not is_edit else url_for('leave.edit', id=leave_request.id) }}">
                    {{ form.hidden_tag() }}
                    
                    <!-- Leave Type Field -->
                    <div class="mb-3">
                        <label for="{{ form.leave_type_id.id }}" class="form-label">Leave Type</label>
                        {{ form.leave_type_id(class="form-select") }}
                        {% if form.leave_type_id.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.leave_type_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <!-- Start Date Field -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.start_date.id }}" class="form-label">Start Date</label>
                            {{ form.start_date(class="form-control", type="date") }}
                            {% if form.start_date.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.start_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- End Date Field -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.end_date.id }}" class="form-label">End Date</label>
                            {{ form.end_date(class="form-control", type="date") }}
                            {% if form.end_date.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.end_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Leave Days Calculation -->
                    <div class="mb-3">
                        <label class="form-label">Number of Leave Days</label>
                        <input type="text" class="form-control" id="leave_days" readonly>
                    </div>
                    
                    <!-- Reason Field -->
                    <div class="mb-4">
                        <label for="{{ form.reason.id }}" class="form-label">Reason for Leave</label>
                        {{ form.reason(class="form-control", rows="4", placeholder="Please provide a detailed reason for your leave request") }}
                        {% if form.reason.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.reason.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text mt-1">
                            <i class="fas fa-info-circle me-1"></i> Your request will be reviewed by your department manager and then by an account manager.
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex justify-content-end mt-4">
                        <a href="{{ url_for('leave.index') }}" class="btn btn-light me-2">Cancel</a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Leave Policy Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">Leave Policy</h3>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>You can request leaves for past, present, or future dates.</li>
                    <li>Leave requests can only be edited or deleted while they are still in <span class="text-warning">Pending</span> status.</li>
                    <li>The approval workflow for leave requests: <b>Direct Manager</b> â†’ <b>Account Manager (Admin)</b></li>
                    <li>Please provide a clear and detailed reason for your leave request to help in the approval process.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        const leaveDaysInput = document.getElementById('leave_days');
        
        function calculateDays() {
            if (startDateInput.value && endDateInput.value) {
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
                leaveDaysInput.value = days + ' day' + (days > 1 ? 's' : '');
            } else {
                leaveDaysInput.value = '';
            }
        }

        // Initialize Flatpickr for date inputs to show calendar picker
        if (startDateInput && typeof flatpickr !== 'undefined') {
            flatpickr(startDateInput, {
                dateFormat: "Y-m-d",
                allowInput: true,
                clickOpens: true,
                onChange: function(selectedDates, dateStr, instance) {
                    // Update end date minimum to start date
                    if (endDateInput && selectedDates.length > 0) {
                        if (endDateInput._flatpickr) {
                            endDateInput._flatpickr.set('minDate', selectedDates[0]);
                        }
                        // Also update native min attribute
                        endDateInput.min = dateStr;
                        if (endDateInput.value && endDateInput.value < dateStr) {
                            endDateInput.value = dateStr;
                            if (endDateInput._flatpickr) {
                                endDateInput._flatpickr.setDate(dateStr);
                            }
                        }
                    }
                    calculateDays();
                }
            });
        }
        
        if (endDateInput && typeof flatpickr !== 'undefined') {
            flatpickr(endDateInput, {
                dateFormat: "Y-m-d",
                allowInput: true,
                clickOpens: true,
                onChange: function(selectedDates, dateStr, instance) {
                    calculateDays();
                }
            });
        }

        if (startDateInput && endDateInput) {
            // Also keep native change listeners for compatibility
            startDateInput.addEventListener('change', function() {
                endDateInput.min = this.value;
                if (endDateInput.value && endDateInput.value < this.value) {
                    endDateInput.value = this.value;
                    if (endDateInput._flatpickr) {
                        endDateInput._flatpickr.setDate(this.value);
                    }
                }
                calculateDays();
            });

            endDateInput.addEventListener('change', calculateDays);
            
            // Calculate initial value if dates are pre-filled (e.g., in edit mode)
            calculateDays();
        }
    });
</script>
{% endblock %}

