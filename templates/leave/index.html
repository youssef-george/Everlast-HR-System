{% extends "layout.html" %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Leave Requests</h1>
    <div class="content-header-actions">
        {% if current_user.role != 'director' %}
        <a href="{{ url_for('leave.create') }}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-1"></i> New Leave Request
        </a>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Filter Options</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Status</label>
                        <select id="status-filter" class="form-select">
                            <option value="all">All</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    {% if current_user.role in ['manager', 'admin', 'director'] %}
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Department</label>
                        <select id="department-filter" class="form-select">
                            <option value="all">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.department_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Date Range</label>
                        <select id="date-filter" class="form-select">
                            <option value="all">All Dates</option>
                            <option value="current_month">Current Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="current_year">Current Year</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button id="apply-filters" class="btn btn-light w-100">Apply Filters</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">Leave Request List</h3>
                <div class="d-flex align-items-center">
                    <span id="total-records" class="text-muted me-3">Total: {{ leave_requests|length }}</span>
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="export-csv">Export to CSV</a></li>
                            <li><a class="dropdown-item" href="#" id="export-pdf">Export to PDF</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover" id="leave-requests-table">
                        <thead>
                            <tr>
                                {% if current_user.role in ['manager', 'admin', 'director'] %}
                                <th>Employee</th>
                                <th>Department</th>
                                {% endif %}
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Duration</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th class="approval-column">Approvals</th>
                                <th>Created On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if leave_requests %}
                                {% for leave in leave_requests %}
                                <tr data-status="{{ leave.status }}" data-department="{{ leave.user.department_id if leave.user.department_id else 'none' }}">
                                    {% if current_user.role in ['manager', 'admin', 'director'] %}
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="symbol symbol-35px me-2">
                                                <span class="symbol-label bg-light-primary text-primary">
                                                    {{ leave.user.first_name[0] }}{{ leave.user.last_name[0] }}
                                                </span>
                                            </div>
                                            <div>{{ leave.user.first_name }} {{ leave.user.last_name }}</div>
                                        </div>
                                    </td>
                                    <td>{{ leave.user.department.department_name if leave.user.department else 'No Department' }}</td>
                                    {% endif %}
                                    <td>{{ leave.start_date.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ leave.end_date.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ (leave.end_date - leave.start_date).days + 1 }} days</td>
                                    <td>{{ leave.reason|truncate(30) }}</td>
                                    <td>
                                        {% if leave.status == 'pending' %}
                                            <span class="badge badge-light-warning">Pending</span>
                                        {% elif leave.status == 'approved' %}
                                            <span class="badge badge-light-success">Approved</span>
                                        {% else %}
                                            <span class="badge badge-light-danger">Rejected</span>
                                        {% endif %}
                                    </td>
                                    <td class="approval-column">
                                        <div class="d-flex flex-column">
                                            <div class="mb-1">
                                                <span class="fw-bold me-1">Manager:</span>
                                                {% if leave.manager_approved %}
                                                    <span class="badge badge-light-success">✓</span>
                                                {% else %}
                                                    <span class="badge badge-light-warning">Pending</span>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <span class="fw-bold me-1">Admin:</span>
                                                {% if leave.admin_approved %}
                                                    <span class="badge badge-light-success">✓</span>
                                                {% else %}
                                                    <span class="badge badge-light-warning">Pending</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ leave.created_at.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        <a href="{{ url_for('leave.view', id=leave.id) }}" class="btn btn-sm btn-icon btn-light me-1" data-bs-toggle="tooltip" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if leave.user_id == current_user.id and leave.status == 'pending' %}
                                            <a href="{{ url_for('leave.edit', id=leave.id) }}" class="btn btn-sm btn-icon btn-light me-1" data-bs-toggle="tooltip" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('leave.delete', id=leave.id) }}" class="d-inline" data-confirm="Are you sure you want to delete this leave request?">
                                                {{ csrf_token() }}
                                                <button type="submit" class="btn btn-sm btn-icon btn-light-danger" data-bs-toggle="tooltip" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="{{ 10 if current_user.role in ['manager', 'admin', 'director'] else 8 }}" class="text-center p-4">No leave requests found.</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Apply filters
        const statusFilter = document.getElementById('status-filter');
        const departmentFilter = document.getElementById('department-filter');
        const dateFilter = document.getElementById('date-filter');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const totalRecords = document.getElementById('total-records');
        
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function() {
                const status = statusFilter.value;
                const department = departmentFilter ? departmentFilter.value : 'all';
                const dateRange = dateFilter.value;
                
                // Get all rows
                const rows = document.querySelectorAll('#leave-requests-table tbody tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    let visible = true;
                    
                    // Filter by status
                    if (status !== 'all' && row.dataset.status !== status) {
                        visible = false;
                    }
                    
                    // Filter by department
                    if (department !== 'all' && row.dataset.department !== department) {
                        visible = false;
                    }
                    
                    // Filter by date range
                    // This would need backend implementation or more complex client-side logic
                    
                    row.style.display = visible ? '' : 'none';
                    if (visible) visibleCount++;
                });
                
                // Update total count
                totalRecords.textContent = `Showing: ${visibleCount} of {{ leave_requests|length }}`;
            });
        }
        
        // Export functionality (mock)
        const exportCsv = document.getElementById('export-csv');
        const exportPdf = document.getElementById('export-pdf');
        
        if (exportCsv) {
            exportCsv.addEventListener('click', function(e) {
                e.preventDefault();
                alert('CSV export functionality would be implemented here.');
            });
        }
        
        if (exportPdf) {
            exportPdf.addEventListener('click', function(e) {
                e.preventDefault();
                alert('PDF export functionality would be implemented here.');
            });
        }
    });
</script>
{% endblock %}
