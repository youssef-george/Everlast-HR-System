{% extends "layout.html" %}

{% block extra_css %}
<style>
.ck-editor__editable {
    min-height: 400px;
}

/* Image size controls in editor */
.ck-editor__editable img {
    max-width: 1200px;
    min-width: 100px;
    width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1rem 0;
    object-fit: contain;
}

.ck-editor__editable img[style*="width"] {
    height: auto !important;
    max-width: 1200px !important;
    min-width: 100px !important;
}

/* Ensure images maintain aspect ratio */
.ck-editor__editable .image {
    display: block;
    max-width: 1200px;
    min-width: 100px;
}

.ck-editor__editable .image_resized {
    max-width: 1200px;
    min-width: 100px;
}

/* Prevent images from being too small or too large */
.ck-editor__editable figure {
    max-width: 1200px;
    min-width: 100px;
    margin: 1rem auto;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- CKEditor 5 -->
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">
        <i class="fas fa-{% if is_create %}plus{% else %}edit{% endif %} me-2"></i>
        {% if is_create %}Create{% else %}Edit{% endif %} Documentation Page
    </h1>
    <div class="content-header-actions">
        <a href="{{ url_for('documentation.admin_panel') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Admin Panel
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="docForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control") }}
                        {% if form.title.errors %}
                            <div class="text-danger small">
                                {% for error in form.title.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.category.label(class="form-label") }}
                        {{ form.category(class="form-select") }}
                        {% if form.category.errors %}
                            <div class="text-danger small">
                                {% for error in form.category.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", id="doc_content") }}
                        {% if form.content.errors %}
                            <div class="text-danger small">
                                {% for error in form.content.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Use the rich text editor to format your content. You can add images, links, and format text.
                            <br>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Image Size Limits:</strong> Minimum width: 100px, Maximum width: 1200px. Images will be automatically resized to fit these constraints.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.tags.label(class="form-label") }}
                        {{ form.tags(class="form-control") }}
                        {% if form.tags.errors %}
                            <div class="text-danger small">
                                {% for error in form.tags.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Enter comma-separated tags (e.g., leave, request, how-to)
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.visible_roles.label(class="form-label") }}
                        <div class="border rounded p-3">
                            {% for choice in form.visible_roles %}
                            <div class="form-check">
                                {{ choice(class="form-check-input") }}
                                {{ choice.label(class="form-check-label") }}
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.visible_roles.errors %}
                            <div class="text-danger small">
                                {% for error in form.visible_roles.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Select which roles can view this documentation page. If no roles are selected, the page will be hidden.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_published(class="form-check-input") }}
                            {{ form.is_published.label(class="form-check-label") }}
                        </div>
                        {% if form.is_published.errors %}
                            <div class="text-danger small">
                                {% for error in form.is_published.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save & Publish
                        </button>
                        <button type="submit" name="save_draft" class="btn btn-secondary">
                            <i class="fas fa-file-alt me-1"></i>Save as Draft
                        </button>
                        <a href="{{ url_for('documentation.admin_panel') }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize CKEditor
let editor;

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    const textareaElement = document.querySelector('#doc_content');
    
    // Check if element exists before initializing
    if (!textareaElement) {
        console.error('Textarea element #doc_content not found');
        return;
    }
    
    // Remove required attribute to prevent validation issues when textarea is hidden by CKEditor
    // We'll handle validation manually
    const wasRequired = textareaElement.hasAttribute('required');
    if (wasRequired) {
        textareaElement.removeAttribute('required');
    }
    
    // Initialize CKEditor
ClassicEditor
        .create(textareaElement, {
        toolbar: {
            items: [
                'heading', '|',
                'bold', 'italic', 'link', '|',
                'bulletedList', 'numberedList', '|',
                'outdent', 'indent', '|',
                'blockQuote', 'insertTable', '|',
                'imageUpload', 'mediaEmbed', '|',
                'undo', 'redo'
            ]
        },
        heading: {
            options: [
                { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
            ]
        },
        image: {
                toolbar: [
                    'imageTextAlternative',
                    '|',
                    'imageStyle:alignLeft',
                    'imageStyle:alignCenter',
                    'imageStyle:alignRight',
                    '|',
                    'imageStyle:inline',
                    'imageStyle:block',
                    'imageStyle:side'
                ],
                styles: [
                    'full',
                    'side',
                    'alignLeft',
                    'alignCenter',
                    'alignRight'
                ]
        },
        table: {
            contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
        },
        simpleUpload: {
            uploadUrl: '{{ url_for("documentation.upload_image") }}',
            withCredentials: true,
            headers: {
                    'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value || ''
            }
        }
    })
    .then(ed => {
        editor = ed;
            console.log('CKEditor initialized successfully');
            
            // Image size constraints
            const MIN_IMAGE_WIDTH = 100;  // Minimum width in pixels
            const MAX_IMAGE_WIDTH = 1200; // Maximum width in pixels
            
            // Function to validate and adjust image size
            function validateImageSize(imgElement) {
                return new Promise((resolve) => {
                    if (imgElement.complete) {
                        processImageSize(imgElement);
                        resolve();
                    } else {
                        imgElement.onload = () => {
                            processImageSize(imgElement);
                            resolve();
                        };
                        imgElement.onerror = resolve;
                    }
                });
            }
            
            function processImageSize(imgElement) {
                const naturalWidth = imgElement.naturalWidth || imgElement.width;
                
                if (naturalWidth < MIN_IMAGE_WIDTH) {
                    console.warn(`Image width (${naturalWidth}px) is below minimum (${MIN_IMAGE_WIDTH}px). Adjusting...`);
                    // Scale up to minimum
                    const scale = MIN_IMAGE_WIDTH / naturalWidth;
                    imgElement.style.width = MIN_IMAGE_WIDTH + 'px';
                    imgElement.style.height = 'auto';
                } else if (naturalWidth > MAX_IMAGE_WIDTH) {
                    console.warn(`Image width (${naturalWidth}px) exceeds maximum (${MAX_IMAGE_WIDTH}px). Constraining...`);
                    // Scale down to maximum
                    imgElement.style.maxWidth = MAX_IMAGE_WIDTH + 'px';
                    imgElement.style.width = '100%';
                    imgElement.style.height = 'auto';
                }
                
                // Always ensure min/max constraints in style
                const currentStyle = imgElement.getAttribute('style') || '';
                if (!currentStyle.includes('min-width')) {
                    imgElement.style.minWidth = MIN_IMAGE_WIDTH + 'px';
                }
                if (!currentStyle.includes('max-width')) {
                    imgElement.style.maxWidth = MAX_IMAGE_WIDTH + 'px';
                }
                imgElement.style.height = 'auto';
            }
            
            // Process images before form submission to ensure proper sizing with min/max constraints
            const originalUpdateSourceElement = editor.updateSourceElement.bind(editor);
            editor.updateSourceElement = function() {
                originalUpdateSourceElement();
                
                // Process images in the textarea content
                const textarea = document.querySelector('#doc_content');
                if (textarea && textarea.value) {
                    // Create a temporary div to parse HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = textarea.value;
                    
                    // Process all images
                    const images = tempDiv.querySelectorAll('img');
                    for (const img of images) {
                        const width = img.getAttribute('width');
                        let style = img.getAttribute('style') || '';
                        let currentWidth = null;
                        
                        // Get current width from attribute or style
                        if (width) {
                            currentWidth = parseInt(width);
                        } else {
                            // Try to extract from style
                            const widthMatch = style.match(/width:\s*(\d+)px/i);
                            if (widthMatch) {
                                currentWidth = parseInt(widthMatch[1]);
                            }
                        }
                        
                        // Clean up existing width/min-width/max-width from style
                        style = style.replace(/width:\s*\d+px/gi, '')
                                     .replace(/min-width:\s*\d+px/gi, '')
                                     .replace(/max-width:\s*\d+px/gi, '')
                                     .replace(/height:\s*\d+px/gi, '')
                                     .replace(/height:\s*auto/gi, '')
                                     .replace(/;\s*;/g, ';')
                                     .replace(/^\s*;\s*/, '')
                                     .replace(/\s*;\s*$/, '');
                        
                        // Apply min/max constraints
                        if (currentWidth !== null) {
                            if (currentWidth < MIN_IMAGE_WIDTH) {
                                // Enforce minimum width
                                img.removeAttribute('width');
                                style = (style ? style + '; ' : '') + `min-width: ${MIN_IMAGE_WIDTH}px; max-width: ${MAX_IMAGE_WIDTH}px; width: 100%; height: auto;`;
                            } else if (currentWidth > MAX_IMAGE_WIDTH) {
                                // Enforce maximum width
                                img.removeAttribute('width');
                                style = (style ? style + '; ' : '') + `min-width: ${MIN_IMAGE_WIDTH}px; max-width: ${MAX_IMAGE_WIDTH}px; width: 100%; height: auto;`;
                            } else {
                                // Within range, ensure responsive with constraints
                                img.removeAttribute('width');
                                style = (style ? style + '; ' : '') + `min-width: ${MIN_IMAGE_WIDTH}px; max-width: ${MAX_IMAGE_WIDTH}px; width: 100%; height: auto;`;
                            }
                        } else {
                            // No width specified, add min/max constraints
                            style = (style ? style + '; ' : '') + `min-width: ${MIN_IMAGE_WIDTH}px; max-width: ${MAX_IMAGE_WIDTH}px; width: 100%; height: auto;`;
                        }
                        
                        // Remove height attribute and set style
                        img.removeAttribute('height');
                        img.setAttribute('style', style);
                    }
                    
                    // Update textarea with processed content
                    textarea.value = tempDiv.innerHTML;
                }
            };
            
            // Monitor image insertion and enforce size constraints
            editor.model.document.on('change:data', () => {
                const viewDocument = editor.editing.view.document;
                const viewRoot = viewDocument.getRoot();
                
                // Process images in the editor view
                const viewWriter = editor.editing.view;
                const viewImages = Array.from(viewRoot.getChildren()).filter(item => 
                    item.is && (item.is('element', 'imageBlock') || item.is('element', 'imageInline'))
                );
                
                viewImages.forEach(imageElement => {
                    if (imageElement && imageElement.getStyle) {
                        const width = imageElement.getStyle('width');
                        if (width) {
                            const widthNum = parseInt(width);
                            if (widthNum < MIN_IMAGE_WIDTH) {
                                imageElement.setStyle('width', MIN_IMAGE_WIDTH + 'px');
                            } else if (widthNum > MAX_IMAGE_WIDTH) {
                                imageElement.setStyle('max-width', MAX_IMAGE_WIDTH + 'px');
                                imageElement.setStyle('width', '100%');
                            }
                        }
                    }
                });
            });
    })
    .catch(error => {
        console.error('Error initializing CKEditor:', error);
            // Restore required attribute if CKEditor failed to initialize
            if (wasRequired) {
                textareaElement.setAttribute('required', 'required');
            }
    });

// Handle form submission
    const form = document.getElementById('docForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Update textarea with editor content before validation
    if (editor) {
        editor.updateSourceElement();
                
                // Custom validation: check if content is empty
                const content = textareaElement.value.trim();
                if (!content) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger small mt-1';
                    errorDiv.textContent = 'This field is required.';
                    
                    // Remove existing error messages
                    const existingError = textareaElement.parentElement.querySelector('.text-danger.small');
                    if (existingError) {
                        existingError.remove();
                    }
                    
                    // Add error message
                    textareaElement.parentElement.appendChild(errorDiv);
                    
                    // Scroll to error
                    textareaElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Focus on editor
                    if (editor.editing && editor.editing.view) {
                        editor.editing.view.focus();
                    }
                    
                    return false;
                }
            }
        });
    }
});
</script>
{% endblock %}

