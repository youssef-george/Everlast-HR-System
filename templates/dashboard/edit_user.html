{% extends "layout.html" %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Edit User</h1>
    <div class="content-header-actions">
        <a href="{{ url_for('dashboard.users') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Users
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8 col-xl-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Edit {{ user.first_name }} {{ user.last_name }}</h3>
            </div>
            <div class="card-body">
                <!-- Display flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Display form validation errors -->
                {% if form.errors %}
                    <div class="alert alert-danger" role="alert">
                        <h6 class="alert-heading">Please correct the following errors:</h6>
                        <ul class="mb-0">
                            {% for field, errors in form.errors.items() %}
                                {% for error in errors %}
                                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('dashboard.edit_user', user_id=user.id) }}" id="edit-user-form">
                    {{ form.hidden_tag() }}
                    
                    <!-- 1. Full Name -->
                    <div class="mb-3">
                        {{ form.full_name.label(class="form-label") }}
                        {{ form.full_name(class="form-control", placeholder="Enter full name (optional)") }}
                        {% if form.full_name.errors %}
                            <div class="text-danger">
                                {% for error in form.full_name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Full name as it should appear in the system</small>
                    </div>
                    
                    <!-- 2. First Name -->
                    <div class="mb-3">
                        {{ form.first_name.label(class="form-label") }}
                        {{ form.first_name(class="form-control") }}
                        {% if form.first_name.errors %}
                            <div class="text-danger">
                                {% for error in form.first_name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 2. Last Name -->
                    <div class="mb-3">
                        {{ form.last_name.label(class="form-label") }}
                        {{ form.last_name(class="form-control") }}
                        {% if form.last_name.errors %}
                            <div class="text-danger">
                                {% for error in form.last_name.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 3. Email -->
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control") }}
                        {% if form.email.errors %}
                            <div class="text-danger">
                                {% for error in form.email.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 4. Employee Code -->
                    <div class="mb-3">
                        {{ form.employee_code.label(class="form-label") }}
                        {{ form.employee_code(class="form-control", placeholder="Enter employee code (optional)") }}
                        {% if form.employee_code.errors %}
                            <div class="text-danger">
                                {% for error in form.employee_code.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Unique employee identification code</small>
                    </div>
                    
                    <!-- 5. Fingerprint Number -->
                    {% if current_user.role in ['admin', 'product_owner'] %}
                    <div class="mb-3">
                        {{ form.fingerprint_number.label(class="form-label") }}
                        {{ form.fingerprint_number(class="form-control", placeholder="Enter fingerprint number (optional)") }}
                        {% if form.fingerprint_number.errors %}
                            <div class="text-danger">
                                {% for error in form.fingerprint_number.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- 6. Department -->
                    <div class="mb-3">
                        {{ form.department_id.label(class="form-label") }}
                        {{ form.department_id(class="form-select") }}
                        {% if form.department_id.errors %}
                            <div class="text-danger">
                                {% for error in form.department_id.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 7. Position -->
                    <div class="mb-3">
                        {{ form.position.label(class="form-label") }}
                        {{ form.position(class="form-control", placeholder="e.g., Software Developer, Manager, etc.") }}
                        {% if form.position.errors %}
                            <div class="text-danger">
                                {% for error in form.position.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 8. Joining Date -->
                    <div class="mb-3">
                        {{ form.joining_date.label(class="form-label") }}
                        {{ form.joining_date(class="form-control") }}
                        {% if form.joining_date.errors %}
                            <div class="text-danger">
                                {% for error in form.joining_date.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 9. Date of Birth -->
                    <div class="mb-3">
                        {{ form.date_of_birth.label(class="form-label") }}
                        {{ form.date_of_birth(class="form-control") }}
                        {% if form.date_of_birth.errors %}
                            <div class="text-danger">
                                {% for error in form.date_of_birth.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 10. Insurance Number -->
                    <div class="mb-3">
                        {{ form.insurance_number.label(class="form-label") }}
                        {{ form.insurance_number(class="form-control", placeholder="Enter insurance number (optional)") }}
                        {% if form.insurance_number.errors %}
                            <div class="text-danger">
                                {% for error in form.insurance_number.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Employee insurance number</small>
                    </div>
                    
                    <!-- 11. Phone Numbers -->
                    <div class="mb-3">
                        {{ form.phone_number.label(class="form-label") }}
                        {{ form.phone_number(class="form-control", placeholder="e.g., +1-555-123-4567") }}
                        {% if form.phone_number.errors %}
                            <div class="text-danger">
                                {% for error in form.phone_number.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.alternate_phone_number.label(class="form-label") }}
                        {{ form.alternate_phone_number(class="form-control", placeholder="e.g., +1-555-987-6543") }}
                        {% if form.alternate_phone_number.errors %}
                            <div class="text-danger">
                                {% for error in form.alternate_phone_number.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Additional fields (Role, Status, Avaya, Salary) -->
                    <div class="separator my-4"></div>
                    <h4 class="mb-3">Administrative Information</h4>
                    
                    <div class="mb-3">
                        {{ form.role.label(class="form-label") }}
                        {% if is_editing_product_owner %}
                            {{ form.role(class="form-select", disabled=true) }}
                            <div class="alert alert-warning mt-2">
                                <i class="fas fa-shield-alt me-2"></i>
                                <strong>Protected Account:</strong> Product Owner role cannot be changed. This account is protected from role modifications.
                            </div>
                        {% else %}
                            {{ form.role(class="form-select") }}
                        {% endif %}
                        {% if form.role.errors %}
                            <div class="text-danger">
                                {% for error in form.role.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.status.label(class="form-label") }}
                        {{ form.status(class="form-select") }}
                        {% if form.status.errors %}
                            <div class="text-danger">
                                {% for error in form.status.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.avaya_number.label(class="form-label") }}
                        {{ form.avaya_number(class="form-control", placeholder="Enter Avaya number (optional)") }}
                        {% if form.avaya_number.errors %}
                            <div class="text-danger">
                                {% for error in form.avaya_number.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.salary.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.currency(class="form-select", style="max-width: 120px;") }}
                            {{ form.salary(class="form-control", placeholder="0.00", step="0.01") }}
                        </div>
                        {% if form.salary.errors %}
                            <div class="text-danger">
                                {% for error in form.salary.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.currency.errors %}
                            <div class="text-danger">
                                {% for error in form.currency.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    
                    <!-- 12. Password -->
                    <div class="separator my-4"></div>
                    
                    {% set is_protected = (user.email.lower() == 'youssef.george0458@gmail.com' or user.email.lower() == 'erp@everlastwellness.com') %}
                    
                    {% if not is_protected %}
                    <h4 class="mb-3">Change Password</h4>
                    <p class="text-muted mb-3">Leave these fields empty if you don't want to change the user's password.</p>
                    
                    <!-- New Password Field -->
                    <div class="mb-3">
                        {{ form.new_password.label(class="form-label") }}
                        {{ form.new_password(class="form-control", placeholder="Enter new password") }}
                        {% if form.new_password.errors %}
                            <div class="text-danger">
                                {% for error in form.new_password.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Password must be at least 8 characters long.
                        </div>
                    </div>
                    
                    <!-- Confirm Password Field -->
                    <div class="mb-3">
                        {{ form.confirm_password.label(class="form-label") }}
                        {{ form.confirm_password(class="form-control", placeholder="Confirm new password") }}
                        {% if form.confirm_password.errors %}
                            <div class="text-danger">
                                {% for error in form.confirm_password.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <h4 class="mb-3">Change Password</h4>
                    <div class="alert alert-warning">
                        <i class="fas fa-lock me-2"></i>
                        <strong>Protected System Account:</strong> Password changes are not allowed for <strong>{{ user.email }}</strong>. This is a protected system account and password changes are restricted for security reasons.
                    </div>
                    {% endif %}
                    
                    <!-- 13. Attachments -->
                    <div class="separator my-4"></div>
                    
                    <h4 class="mb-3">Employee Attachments</h4>
                    <p class="text-muted mb-3">Upload and manage employee documents and files.</p>
                    
                    <!-- Upload New Attachment Form -->
                    
                    <!-- Existing Attachments -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Existing Attachments</h5>
                        </div>
                        <div class="card-body">
                            {% if user.attachments %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Display Name</th>
                                                <th>File Name</th>
                                                <th>Size</th>
                                                <th>Uploaded</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for attachment in user.attachments %}
                                            <tr>
                                                <td>
                                                    <strong>{{ attachment.display_name }}</strong>
                                                    {% if attachment.description %}
                                                        <br><small class="text-muted">{{ attachment.description }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>{{ attachment.file_name }}</td>
                                                <td>
                                                    {% if attachment.file_size %}
                                                        {{ "%.1f"|format(attachment.file_size / 1024) }} KB
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td>{{ attachment.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{{ url_for('dashboard.download_attachment', attachment_id=attachment.id) }}" 
                                                           class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-download"></i> Download
                                                        </a>
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm delete-attachment-btn" 
                                                                data-attachment-id="{{ attachment.id }}"
                                                                title="Delete File"
                                                                data-bs-toggle="tooltip"
                                                                onclick="console.log('ðŸ”´ INLINE ONCLICK FIRED'); event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); var btn = this; var id = btn.getAttribute('data-attachment-id'); console.log('ðŸ”´ Attachment ID from onclick:', id); if(id && window.deleteAttachment) { console.log('ðŸ”´ Calling deleteAttachment with ID:', id); window.deleteAttachment(id); } else { console.error('âŒ deleteAttachment not available or ID missing', {id: id, func: typeof window.deleteAttachment}); } return false;"
                                                                style="cursor: pointer;">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-file-upload fa-3x mb-3"></i>
                                    <p>No attachments uploaded yet.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('dashboard.users') }}" class="btn btn-secondary">
                            Cancel
                        </a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
                
                <!-- ATTACHMENT FORM (separate from main edit form) -->
                <div class="card mb-4 mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Upload New Attachment</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('dashboard.upload_attachment', user_id=user.id) }}" enctype="multipart/form-data" id="upload-attachment-form">
                            {{ attachment_form.hidden_tag() }}
                            
                            <div class="mb-3">
                                {{ attachment_form.file.label(class="form-label") }}
                                {{ attachment_form.file(class="form-control") }}
                                {% if attachment_form.file.errors %}
                                    <div class="text-danger">
                                        {% for error in attachment_form.file.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                {{ attachment_form.display_name.label(class="form-label") }}
                                {{ attachment_form.display_name(class="form-control", placeholder="e.g., Passport Copy, Contract, etc.") }}
                                {% if attachment_form.display_name.errors %}
                                    <div class="text-danger">
                                        {% for error in attachment_form.display_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                {{ attachment_form.description.label(class="form-label") }}
                                {{ attachment_form.description(class="form-control", rows="3", placeholder="Optional description...") }}
                                {% if attachment_form.description.errors %}
                                    <div class="text-danger">
                                        {% for error in attachment_form.description.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                {{ attachment_form.submit(class="btn btn-success") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Flatpickr CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // Define deleteAttachment function IMMEDIATELY (before DOMContentLoaded)
    (function() {
        window.deleteAttachment = function(attachmentId) {
            console.log('ðŸ”´ deleteAttachment() called with ID:', attachmentId);
            
            if (confirm('Are you sure you want to delete this attachment? This action cannot be undone.')) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                                 document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
                
                if (!csrfToken) {
                    alert('Security token not found. Please refresh the page and try again.');
                    return false;
                }
                
                console.log('ðŸ“¤ Sending POST request to:', '/dashboard/delete-attachment/' + attachmentId);
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/dashboard/delete-attachment/' + attachmentId, true);
                xhr.setRequestHeader('X-CSRFToken', csrfToken);
                xhr.setRequestHeader('X-CSRF-Token', csrfToken);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.withCredentials = true;
                
                xhr.onload = function() {
                    console.log('ðŸ“¥ Response received:', xhr.status, xhr.statusText);
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                console.log('âœ… Delete successful, reloading page');
                                location.reload();
                            } else {
                                alert('Error: ' + (data.message || 'Unknown error'));
                            }
                        } catch (e) {
                            console.error('âŒ Parse error:', e);
                            alert('Error parsing server response');
                        }
                    } else {
                        console.error('âŒ HTTP Error:', xhr.status, xhr.statusText);
                        alert('Error: ' + xhr.statusText);
                    }
                };
                
                xhr.onerror = function() {
                    console.error('âŒ Network error');
                    alert('Network error. Please check your connection.');
                };
                
                xhr.send('csrf_token=' + encodeURIComponent(csrfToken));
            }
            return false;
        };
        console.log('âœ… deleteAttachment function defined globally');
    })();

    // Delete attachment functionality - ULTRA AGGRESSIVE approach
    // Intercept ALL clicks on delete buttons at the document level - RUNS IMMEDIATELY
    (function() {
        function handleDeleteClick(e) {
            // Check if clicked element or its parent is a delete button
            let deleteBtn = e.target.closest('.delete-attachment-btn');
            
            // Also check if the clicked element itself has the class
            if (!deleteBtn && e.target.classList && e.target.classList.contains('delete-attachment-btn')) {
                deleteBtn = e.target;
            }
            
            // Also check if clicked element is inside a delete button (like an icon)
            if (!deleteBtn) {
                const icon = e.target.closest('i.fa-trash');
                if (icon) {
                    deleteBtn = icon.closest('.delete-attachment-btn');
                }
            }
            
            if (deleteBtn) {
                console.log('ðŸ”´ DELETE BUTTON CLICKED - INTERCEPTING (Document Level)');
                console.log('ðŸ”´ Event type:', e.type);
                console.log('ðŸ”´ Target:', e.target);
                console.log('ðŸ”´ Current target:', e.currentTarget);
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const attachmentId = deleteBtn.getAttribute('data-attachment-id');
                
                if (!attachmentId) {
                    console.error('âŒ Attachment ID not found');
                    return false;
                }
                
                console.log('âœ… Attachment ID found:', attachmentId);
                console.log('âœ… deleteAttachment available:', typeof window.deleteAttachment);
                
                if (window.deleteAttachment) {
                    window.deleteAttachment(attachmentId);
                } else {
                    console.error('âŒ deleteAttachment function not available');
                    alert('Delete function not loaded. Please refresh the page.');
                }
                
                return false;
            }
        }
        
        // Attach immediately (before DOMContentLoaded) - use capture phase
        document.addEventListener('click', handleDeleteClick, true);
        console.log('âœ… Delete attachment handler attached at document level (capture phase)');
    })();

    document.addEventListener('DOMContentLoaded', function() {
        // Password strength validation
        const newPasswordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        
        if (newPasswordInput && confirmPasswordInput) {
            // Check password match
            function checkPasswordMatch() {
                if (newPasswordInput.value && confirmPasswordInput.value) {
                    if (newPasswordInput.value !== confirmPasswordInput.value) {
                        confirmPasswordInput.setCustomValidity('Passwords must match');
                    } else {
                        confirmPasswordInput.setCustomValidity('');
                    }
                } else {
                    confirmPasswordInput.setCustomValidity('');
                }
            }
            
            newPasswordInput.addEventListener('input', checkPasswordMatch);
            confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            
            // Check password strength
            newPasswordInput.addEventListener('input', function() {
                if (this.value.length > 0 && this.value.length < 8) {
                    this.setCustomValidity('Password must be at least 8 characters long');
                } else {
                    this.setCustomValidity('');
                }
            });
        }

        // Initialize date picker for joining_date
        const joiningDateInput = document.getElementById('joining_date');
        if (joiningDateInput && typeof flatpickr !== 'undefined') {
            flatpickr(joiningDateInput, {
                dateFormat: "Y-m-d",
                allowInput: true
            });
        }

        // Initialize date picker for date_of_birth
        const dateOfBirthInput = document.getElementById('date_of_birth');
        if (dateOfBirthInput && typeof flatpickr !== 'undefined') {
            flatpickr(dateOfBirthInput, {
                dateFormat: "Y-m-d",
                allowInput: true
            });
        }

        // Handle form submission
        const editForm = document.getElementById('edit-user-form');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                // Show loading state
                const submitBtn = this.querySelector('input[type="submit"]');
                if (submitBtn) {
                    submitBtn.value = 'Updating...';
                    submitBtn.disabled = true;
                }
                
                // Let the form submit naturally
            });
        }
    });
</script>
{% endblock %}