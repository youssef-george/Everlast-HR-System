{% extends "layout.html" %}

{% block extra_css %}
<style>
    .activity-log-table {
        font-size: 0.9rem;
    }
    .activity-log-table th {
        background: #1e40af;
        color: #ffffff;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 1rem 0.75rem;
    }
    .before-after-container {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    .before-values, .after-values {
        flex: 1;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .before-values {
        background-color: #fee2e2;
        border-left: 3px solid #dc2626;
    }
    .after-values {
        background-color: #d1fae5;
        border-left: 3px solid #10b981;
    }
    .value-item {
        margin-bottom: 0.25rem;
    }
    .value-label {
        font-weight: 600;
        color: #374151;
    }
    .value-content {
        color: #6b7280;
    }
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    .loading-spinner.active {
        display: block;
    }
    .no-results {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }
    .search-container {
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">Activity Log</h1>
    <div class="content-header-actions">
        <span class="text-muted">All user actions are logged here</span>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">System Activity Log</h3>
            </div>
            <div class="card-body">
                <!-- Search and Filters -->
                <div class="search-container">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by user name, action, entity type, or description...">
                        <button class="btn btn-secondary" type="button" id="clearSearchBtn">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading activity logs...</p>
                </div>
                
                <!-- Activity Log Table -->
                <div class="table-responsive" id="activityLogTableContainer">
                    <table class="table table-hover activity-log-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Entity</th>
                                <th>Description</th>
                                <th>IP Address</th>
                                <th>Page Link</th>
                                <th>Changes</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogTableBody">
                            {% if logs.items %}
                                {% for log in logs.items %}
                                <tr>
                                    <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        {% if log.user %}
                                            {{ log.user.get_full_name() }}
                                            <br><small class="text-muted">{{ log.user.email }}</small>
                                        {% else %}
                                            <span class="text-muted">System</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-primary">{{ log.action }}</span></td>
                                    <td>
                                        {% if log.entity_type %}
                                            <span class="badge bg-info">{{ log.entity_type }}</span>
                                            {% if log.entity_id %}
                                                <br><small class="text-muted">ID: {{ log.entity_id }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.description or '-' }}</td>
                                    <td><small class="text-muted">{{ log.ip_address or '-' }}</small></td>
                                    <td>
                                        {% if log.entity_type and log.entity_id %}
                                            {% if log.entity_type == 'permission_request' %}
                                                <a href="{{ url_for('permission.view', id=log.entity_id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> View
                                                </a>
                                            {% elif log.entity_type == 'leave_request' %}
                                                <a href="{{ url_for('leave.view', id=log.entity_id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> View
                                                </a>
                                            {% elif log.entity_type == 'user' %}
                                                <a href="{{ url_for('dashboard.edit_user', user_id=log.entity_id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> View
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.before_values or log.after_values %}
                                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#changes-{{ log.id }}" aria-expanded="false">
                                                <i class="fas fa-eye"></i> View Changes
                                            </button>
                                            <div class="collapse mt-2" id="changes-{{ log.id }}">
                                                <div class="before-after-container">
                                                    {% if log.before_values_parsed %}
                                                    <div class="before-values">
                                                        <strong>Before:</strong>
                                                        {% for key, value in log.before_values_parsed.items() %}
                                                        <div class="value-item">
                                                            <span class="value-label">{{ key }}:</span>
                                                            <span class="value-content">{{ value or '-' }}</span>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                    {% if log.after_values_parsed %}
                                                    <div class="after-values">
                                                        <strong>After:</strong>
                                                        {% for key, value in log.after_values_parsed.items() %}
                                                        <div class="value-item">
                                                            <span class="value-label">{{ key }}:</span>
                                                            <span class="value-content">{{ value or '-' }}</span>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="no-results">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p>No activity logs found.</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if logs.pages > 1 %}
                <nav aria-label="Activity log pagination">
                    <ul class="pagination justify-content-center" id="paginationContainer">
                        {% if logs.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ logs.prev_num }}" id="prevPageLink">Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        {% endif %}
                        
                        {% for page_num in logs.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if page_num %}
                                {% if page_num == logs.page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if logs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ logs.next_num }}" id="nextPageLink">Next</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let searchTimeout;
    let currentPage = {{ logs.page if logs else 1 }};
    
    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Load activity logs via AJAX
    function loadActivityLogs(page = 1) {
        const searchQuery = document.getElementById('searchInput').value.trim();
        
        // Show loading spinner
        document.getElementById('loadingSpinner').classList.add('active');
        document.getElementById('activityLogTableContainer').style.opacity = '0.5';
        
        // Build query string - only search query
        const params = new URLSearchParams({
            page: page,
            q: searchQuery
        });
        
        // Make AJAX request
        fetch(`{{ url_for('dashboard.activity_log_search') }}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('loadingSpinner').classList.remove('active');
                document.getElementById('activityLogTableContainer').style.opacity = '1';
                
                // Update table body
                updateTableBody(data.logs);
                
                // Update pagination
                updatePagination(data.page, data.pages);
                
                currentPage = data.page;
            })
            .catch(error => {
                console.error('Error loading activity logs:', error);
                document.getElementById('loadingSpinner').classList.remove('active');
                document.getElementById('activityLogTableContainer').style.opacity = '1';
                alert('Error loading activity logs. Please try again.');
            });
    }
    
    // Update table body with new data
    function updateTableBody(logs) {
        const tbody = document.getElementById('activityLogTableBody');
        
        if (logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="no-results">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No activity logs found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        logs.forEach(log => {
            const timestamp = new Date(log.created_at).toLocaleString();
            const userDisplay = log.user_name ? 
                `${log.user_name}<br><small class="text-muted">${log.user_email || ''}</small>` : 
                '<span class="text-muted">System</span>';
            
            const entityDisplay = log.entity_type ? 
                `<span class="badge bg-info">${log.entity_type}</span>${log.entity_id ? `<br><small class="text-muted">ID: ${log.entity_id}</small>` : ''}` : 
                '<span class="text-muted">-</span>';
            
            let changesHtml = '<span class="text-muted">-</span>';
            if (log.before_values || log.after_values) {
                const changesId = `changes-${log.id}`;
                let beforeHtml = '';
                let afterHtml = '';
                
                if (log.before_values) {
                    beforeHtml = '<div class="before-values"><strong>Before:</strong>';
                    for (const [key, value] of Object.entries(log.before_values)) {
                        beforeHtml += `<div class="value-item"><span class="value-label">${key}:</span> <span class="value-content">${value || '-'}</span></div>`;
                    }
                    beforeHtml += '</div>';
                }
                
                if (log.after_values) {
                    afterHtml = '<div class="after-values"><strong>After:</strong>';
                    for (const [key, value] of Object.entries(log.after_values)) {
                        afterHtml += `<div class="value-item"><span class="value-label">${key}:</span> <span class="value-content">${value || '-'}</span></div>`;
                    }
                    afterHtml += '</div>';
                }
                
                changesHtml = `
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#${changesId}" aria-expanded="false">
                        <i class="fas fa-eye"></i> View Changes
                    </button>
                    <div class="collapse mt-2" id="${changesId}">
                        <div class="before-after-container">
                            ${beforeHtml}
                            ${afterHtml}
                        </div>
                    </div>
                `;
            }
            
            // Generate page link HTML
            let pageLinkHtml = '<span class="text-muted">-</span>';
            if (log.page_link) {
                pageLinkHtml = `<a href="${log.page_link}" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i> View
                </a>`;
            }
            
            html += `
                <tr>
                    <td>${timestamp}</td>
                    <td>${userDisplay}</td>
                    <td><span class="badge bg-primary">${log.action}</span></td>
                    <td>${entityDisplay}</td>
                    <td>${log.description || '-'}</td>
                    <td><small class="text-muted">${log.ip_address || '-'}</small></td>
                    <td>${pageLinkHtml}</td>
                    <td>${changesHtml}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    // Update pagination
    function updatePagination(currentPage, totalPages) {
        const paginationContainer = document.getElementById('paginationContainer');
        if (!paginationContainer || totalPages <= 1) {
            if (paginationContainer) {
                paginationContainer.innerHTML = '';
            }
            return;
        }
        
        let html = '';
        
        // Previous button
        if (currentPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
        }
        
        // Page numbers
        const leftEdge = 1;
        const rightEdge = totalPages;
        const leftCurrent = Math.max(1, currentPage - 2);
        const rightCurrent = Math.min(totalPages, currentPage + 2);
        
        if (leftCurrent > leftEdge + 1) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
            if (leftCurrent > leftEdge + 2) {
                html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
            }
        }
        
        for (let i = leftCurrent; i <= rightCurrent; i++) {
            if (i === currentPage) {
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
        }
        
        if (rightCurrent < rightEdge - 1) {
            if (rightCurrent < rightEdge - 2) {
                html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }
        
        // Next button
        if (currentPage < totalPages) {
            html += `<li class="page-item"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
        } else {
            html += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
        }
        
        paginationContainer.innerHTML = html;
        
        // Attach click handlers to pagination links
        paginationContainer.querySelectorAll('a.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                loadActivityLogs(page);
            });
        });
    }
    
    // Search input with debounce
    const searchInput = document.getElementById('searchInput');
    const debouncedSearch = debounce(() => {
        loadActivityLogs(1);
    }, 300);
    
    searchInput.addEventListener('input', () => {
        debouncedSearch();
    });
    
    // Clear search button
    document.getElementById('clearSearchBtn').addEventListener('click', () => {
        searchInput.value = '';
        loadActivityLogs(1);
    });
    
    // Initial load only if there's a search query
    {% if logs.items|length == 0 or request.args.get('q') %}
    // Load via AJAX if there's a search query
    loadActivityLogs({{ logs.page if logs else 1 }});
    {% endif %}
})();
</script>
{% endblock %}

