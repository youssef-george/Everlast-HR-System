{% extends "layout.html" %}

{% block extra_css %}
<!-- EMERGENCY TABLE HEADER VISIBILITY FIX FOR ATTENDANCE -->
<style>
/* Force table headers to be visible with maximum specificity */
.table thead th,
.employee-table thead th,
.enhanced-table thead th,
#todaysAttendanceTable thead th,
#historicalAttendanceTable thead th,
table thead th {
    background: #1e40af !important;
    background-color: #1e40af !important;
    background-image: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important;
    color: #ffffff !important;
    font-weight: 700 !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.6) !important;
    font-size: 0.9rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    padding: 1rem 0.75rem !important;
    border: none !important;
    border-bottom: 2px solid #1e3a8a !important;
    opacity: 1 !important;
    visibility: visible !important;
    -webkit-text-fill-color: #ffffff !important;
}

/* Force all child elements in headers to be white */
.table thead th *,
.employee-table thead th *,
.enhanced-table thead th *,
#todaysAttendanceTable thead th *,
#historicalAttendanceTable thead th *,
table thead th * {
    color: #ffffff !important;
    font-weight: 700 !important;
    text-shadow: 0 2px 4px rgba(0,0,0,0.6) !important;
    -webkit-text-fill-color: #ffffff !important;
    opacity: 1 !important;
    visibility: visible !important;
}
</style>
<style>
    /* Enhanced Employee Attendance UI */
    .employee-page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .employee-page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .employee-page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .employee-action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .employee-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
    }
    
    .employee-btn-primary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .employee-btn-primary:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .employee-btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .employee-btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .employee-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: none;
        overflow: hidden;
    }
    
    .employee-card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-bottom: 1px solid #e2e8f0;
        padding: 1.5rem 2rem;
    }
    
    .employee-card-body {
        padding: 2rem;
    }
    
    .employee-table {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .employee-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .employee-table thead th {
        border: none;
        padding: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.85rem;
    }
    
    .employee-table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .employee-table tbody tr:hover {
        background: #f8fafc;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .employee-table tbody td {
        padding: 1rem;
        border: none;
        vertical-align: middle;
    }
    
    .employee-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .employee-badge-present {
        background: #d1fae5;
        color: #059669;
    }
    
    .employee-badge-absent {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .employee-badge-paid-leave {
        background: #dbeafe;
        color: #1d4ed8;
    }
    
    .employee-badge-annual-leave {
        background: #fef3c7;
        color: #d97706;
    }
    
    .employee-badge-sick-leave {
        background: #fce7f3;
        color: #be185d;
    }
    
    .employee-badge-unpaid-leave {
        background: #f3f4f6;
        color: #374151;
    }
    
    .employee-badge-permission {
        background: #e0e7ff;
        color: #3730a3;
    }
    
    .sync-button {
        position: relative;
    }
    .sync-spinner {
        display: none;
        margin-left: 8px;
    }
    .syncing .sync-spinner {
        display: inline-block;
    }
    .check-in {
        color: #28a745;
    }
    .check-out {
        color: #dc3545;
    }
    .unknown {
        color: #6c757d;
    }
    .date-range-form {
        margin-bottom: 1rem;
    }
    .badge.bg-info-light {
        background-color: #0dcaf0;
        color: #fff;
    }
    .badge.bg-blue {
        background-color: #007bff;
        color: #fff;
    }
    .sync-status {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    /* Enhanced Sync Status Alert Styling */
    .sync-status-alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .sync-status-alert .alert-heading {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .sync-status-alert .fa-lg {
        font-size: 1.25rem;
    }
    
    .sync-details {
        margin-top: 0.75rem;
    }
    
    .sync-details .badge {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
    }
    
    .sync-details .badge i {
        font-size: 0.75rem;
        margin-right: 0.25rem;
    }
    
    /* Alert animations */
    .sync-status-alert.fade.show {
        animation: slideInFromTop 0.3s ease-out;
    }
    
    @keyframes slideInFromTop {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .latest-records {
        max-height: 200px;
        overflow-y: auto;
    }
    .latest-record {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    .latest-record:last-child {
        border-bottom: none;
    }
    .auto-sync-toggle {
        margin-right: 1rem;
    }
    .device-status-card {
        min-height: 200px;
    }
    .action-buttons {
        gap: 0.5rem;
    }
    .action-buttons .btn {
        min-width: 140px;
    }
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }
        .action-buttons .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
    
    /* ===== DESKTOP DATE RANGE & TABLE FIXES ===== */
    @media (min-width: 992px) {
        /* Date Range Form - Desktop Optimized */
        .date-range-form {
            background: #ffffff !important;
            padding: 1.5rem !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            margin-bottom: 2rem !important;
        }
        
        .date-range-form .row {
            align-items: flex-end !important;
        }
        
        .date-range-form .col-auto {
            padding: 0.5rem !important;
        }
        
        .date-range-form .form-label {
            color: #1e293b !important;
            font-weight: 600 !important;
            font-size: 0.9rem !important;
            margin-bottom: 0.5rem !important;
            display: block !important;
        }
        
        .date-range-form .form-label i {
            color: #667eea !important;
            font-size: 1rem !important;
            margin-right: 0.5rem !important;
        }
        
        .date-range-form .form-control,
        .date-range-form .form-select {
            background: #ffffff !important;
            border: 2px solid #667eea !important;
            color: #1e293b !important;
            font-size: 0.95rem !important;
            font-weight: 500 !important;
            padding: 0.625rem 1rem !important;
            min-height: 42px !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.15) !important;
            transition: all 0.2s ease !important;
        }
        
        .date-range-form .form-control:focus,
        .date-range-form .form-select:focus {
            border-color: #5a67d8 !important;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
            outline: none !important;
        }
        
        .date-range-form input[type="date"] {
            color: #1e293b !important;
            font-weight: 500 !important;
        }
        
        .date-range-form input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: #667eea !important;
            border-radius: 4px !important;
            padding: 0.25rem !important;
            cursor: pointer !important;
            opacity: 1 !important;
        }
        
        .date-range-form .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%) !important;
            color: #ffffff !important;
            border: none !important;
            font-weight: 600 !important;
            padding: 0.625rem 1.5rem !important;
            min-height: 42px !important;
            font-size: 0.95rem !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
            transition: all 0.2s ease !important;
        }
        
        .date-range-form .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%) !important;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4) !important;
            transform: translateY(-1px) !important;
        }
        
        /* Desktop Table Styling */
        .table-responsive {
            border-radius: 12px !important;
            overflow-x: auto !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }
        
        .table {
            font-size: 0.9rem !important;
            width: 100% !important;
            background: #ffffff !important;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            font-size: 0.85rem !important;
            padding: 1rem 0.75rem !important;
            white-space: nowrap !important;
            text-align: center !important;
            vertical-align: middle !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            border: none !important;
        }
        
        .table tbody td {
            padding: 0.875rem 0.75rem !important;
            font-size: 0.9rem !important;
            vertical-align: middle !important;
            text-align: center !important;
            color: #374151 !important;
            font-weight: 500 !important;
            border-bottom: 1px solid #f3f4f6 !important;
            background: #ffffff !important;
        }
        
        .table tbody tr:hover {
            background: #f8fafc !important;
        }
        
        /* Fingerprint ID Display - Desktop */
        .fingerprint-id-display {
            display: inline-block !important;
            background: #f0f4ff !important;
            color: #1e40af !important;
            font-weight: 600 !important;
            font-size: 0.9rem !important;
            padding: 0.375rem 0.875rem !important;
            border-radius: 6px !important;
            border: 1px solid #3b82f6 !important;
            text-align: center !important;
        }
    }
    
    /* ===== MOBILE DATE RANGE & TABLE FIXES ===== */
    @media (max-width: 991.98px) {
        /* Date Range Form - Enhanced Visibility */
        .date-range-form {
            background: #ffffff !important;
            padding: 1rem !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            margin-bottom: 1.5rem !important;
        }
        
        .date-range-form .row {
            margin: 0 !important;
        }
        
        .date-range-form .col-auto,
        .date-range-form .col-12,
        .date-range-form [class*="col-"] {
            padding: 0.5rem !important;
            margin-bottom: 0.75rem !important;
        }
        
        .date-range-form .col-12 {
            width: 100% !important;
        }
        
        .date-range-form .form-label {
            color: #1e293b !important;
            font-weight: 700 !important;
            font-size: 1rem !important;
            margin-bottom: 0.75rem !important;
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            padding-left: 0.25rem !important;
        }
        
        .date-range-form .form-label[style*="visibility: hidden"] {
            margin-bottom: 0 !important;
            padding: 0 !important;
            height: 0 !important;
            min-height: 0 !important;
        }
        
        .date-range-form .form-label i {
            color: #667eea !important;
            font-size: 1.1rem !important;
            margin-right: 0.5rem !important;
        }
        
        .date-range-form .form-control,
        .date-range-form .form-select {
            width: 100% !important;
            background: #ffffff !important;
            border: 3px solid #667eea !important;
            color: #1e293b !important;
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            padding: 1rem 1.25rem !important;
            min-height: 56px !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3) !important;
            -webkit-appearance: none !important;
            -moz-appearance: textfield !important;
        }
        
        /* Date input specific styling for better visibility */
        .date-range-form input[type="date"] {
            color: #1e293b !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
            background-color: #f8fafc !important;
        }
        
        .date-range-form input[type="date"]::-webkit-calendar-picker-indicator {
            background-color: #667eea !important;
            border-radius: 6px !important;
            padding: 0.5rem !important;
            cursor: pointer !important;
            opacity: 1 !important;
            width: 24px !important;
            height: 24px !important;
        }
        
        .date-range-form input[type="date"]::-webkit-datetime-edit-text {
            color: #1e293b !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
        }
        
        .date-range-form input[type="date"]::-webkit-datetime-edit-month-field,
        .date-range-form input[type="date"]::-webkit-datetime-edit-day-field,
        .date-range-form input[type="date"]::-webkit-datetime-edit-year-field {
            color: #1e293b !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
            padding: 0.25rem !important;
        }
        
        .date-range-form .form-control:focus,
        .date-range-form .form-select:focus {
            border-color: #5a67d8 !important;
            box-shadow: 0 0 0 0.3rem rgba(102, 126, 234, 0.3) !important;
            outline: none !important;
            background: #ffffff !important;
            color: #1e293b !important;
        }
        
        .date-range-form .form-control::placeholder {
            color: #64748b !important;
            font-weight: 500 !important;
        }
        
        .date-range-form .btn-primary {
            width: 100% !important;
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%) !important;
            color: #ffffff !important;
            border: none !important;
            font-weight: 700 !important;
            padding: 0.875rem 1.5rem !important;
            min-height: 56px !important;
            font-size: 1.1rem !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4) !important;
            border-radius: 10px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
            transition: all 0.2s ease !important;
        }
        
        .date-range-form .btn-primary:hover,
        .date-range-form .btn-primary:active {
            background: linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%) !important;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5) !important;
            transform: translateY(-1px) !important;
        }
        
        .date-range-form .btn-primary i {
            font-size: 1.1rem !important;
        }
        
        .date-range-form .alert {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            border: 2px solid #3b82f6 !important;
            color: #1e40af !important;
            font-weight: 700 !important;
            font-size: 1rem !important;
            padding: 0.875rem 1rem !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2) !important;
            margin: 0 !important;
            text-align: center !important;
        }
        
        .date-range-form .alert i {
            font-size: 1.1rem !important;
            margin-right: 0.5rem !important;
        }
        
        /* Input Group Text (for "to" separator) */
        .input-group-text {
            background: #f8fafc !important;
            border: 2px solid #e5e7eb !important;
            color: #1e293b !important;
            font-weight: 600 !important;
            padding: 0.875rem 1rem !important;
            min-height: 48px !important;
        }
        
        /* Fingerprint ID Display - Not a button */
        .fingerprint-id-display {
            display: inline-block !important;
            background: #f0f4ff !important;
            color: #1e40af !important;
            font-weight: 700 !important;
            font-size: 0.95rem !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            border: 2px solid #3b82f6 !important;
            text-align: center !important;
            min-width: 60px !important;
        }
        
        /* Tables - Enhanced Mobile Responsiveness */
        .table-responsive {
            border-radius: 12px !important;
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
            margin: 0 -1rem !important;
            padding: 0 1rem !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }
        
        .table {
            font-size: 0.85rem !important;
            min-width: 1000px !important;
            width: 100% !important;
            background: #ffffff !important;
        }
        
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 0.8rem !important;
            padding: 1rem 0.75rem !important;
            white-space: nowrap !important;
            text-align: center !important;
            vertical-align: middle !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            border: none !important;
        }
        
        .table tbody td {
            padding: 1rem 0.75rem !important;
            font-size: 0.85rem !important;
            vertical-align: middle !important;
            text-align: center !important;
            color: #374151 !important;
            font-weight: 500 !important;
            border-bottom: 1px solid #f3f4f6 !important;
            background: #ffffff !important;
        }
        
        .table tbody tr {
            transition: all 0.2s ease !important;
        }
        
        .table tbody tr:hover {
            background: #f8fafc !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        }
        
        .table .btn-sm {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.8rem !important;
            min-height: 36px !important;
            min-width: 36px !important;
            font-weight: 600 !important;
        }
        
        .table .badge {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
            font-weight: 600 !important;
            border-radius: 6px !important;
        }
        
        /* Historical Attendance Date Headers */
        .card-subtitle {
            font-size: 1.25rem !important;
            font-weight: 700 !important;
            color: #1e293b !important;
            margin-bottom: 1rem !important;
            text-align: center !important;
        }
        
        .table-responsive h6 {
            font-size: 1.1rem !important;
            font-weight: 700 !important;
            color: #1e293b !important;
            margin-top: 1.5rem !important;
            margin-bottom: 0.75rem !important;
            padding: 0.75rem 1rem !important;
            background: #f8fafc !important;
            border-radius: 8px !important;
            border-left: 4px solid #667eea !important;
        }
        
        /* Employee Card Mobile Fixes */
        .employee-card {
            border-radius: 12px !important;
            overflow: hidden !important;
        }
        
        .employee-card-header {
            padding: 1rem 0.75rem !important;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
        }
        
        .employee-card-header .card-title {
            font-size: 1.1rem !important;
            color: #1e293b !important;
            font-weight: 700 !important;
            text-align: center !important;
        }
        
        .employee-card-body {
            padding: 1rem 0.75rem !important;
        }
    }
    
    /* Extra Small Devices */
    @media (max-width: 575.98px) {
        .date-range-form .form-control,
        .date-range-form .form-select {
            font-size: 0.95rem !important;
        }
        
        .table {
            font-size: 0.75rem !important;
            min-width: 900px !important;
        }
        
        .table thead th {
            font-size: 0.7rem !important;
            padding: 0.75rem 0.5rem !important;
        }
        
        .table tbody td {
            font-size: 0.75rem !important;
            padding: 0.75rem 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Enhanced Employee Header -->
        <div class="employee-page-header">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="employee-page-title">
                        <i class="fas fa-clipboard-list me-3"></i>
                        {% if current_user.role == 'employee' %}
                            My Attendance Logs
                        {% else %}
                            Attendance Management
                        {% endif %}
                    </h1>
                    <p class="employee-page-subtitle">
                        {% if current_user.role == 'employee' %}
                            Track your daily attendance and working hours
                        {% else %}
                            Manage employee attendance and monitor working hours
                        {% endif %}
                    </p>
                </div>
                <div class="employee-action-buttons">
                    {% if current_user.role in ['admin', 'product_owner'] %}
                        <button id="syncButton" class="employee-btn employee-btn-primary" onclick="handleSyncClick()">
                            <i class="fas fa-sync-alt"></i> Sync Attendance Now
                        </button>
                        <a href="{{ url_for('attendance.device_settings') }}" class="employee-btn employee-btn-secondary">
                            <i class="fas fa-cog"></i> Device Settings
                        </a>
                    {% endif %}
                    <div id="autoFetchStatus" class="employee-btn employee-btn-secondary" style="opacity: 0.7; pointer-events: none; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i>
                        <span>Auto-Update Active</span>
                    </div>
                </div>
            </div>
        </div>
    
    <div class="row">
        <div class="col-12">
            <div class="employee-card">
                <div class="employee-card-header">
                    <h5 class="card-title mb-0">
                        {% if current_user.role == 'employee' %}
                            My Attendance Logs
                        {% else %}
                            Attendance Management
                        {% endif %}
                    </h5>
                </div>
                <div class="employee-card-body">
                    <!-- Sync Controls - Only for non-employees -->

                    <!-- Date Range Filter -->

                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <form class="date-range-form" method="get">
                                <div class="row g-3">
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label for="start_date" class="form-label fw-bold">
                                            <i class="fas fa-calendar-alt me-2"></i>Start Date
                                        </label>
                                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}" required>
                                    </div>
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label for="end_date" class="form-label fw-bold">
                                            <i class="fas fa-calendar-check me-2"></i>End Date
                                        </label>
                                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}" required>
                                    </div>
                                    
                                    {% if is_admin or current_user.role in ['manager', 'director', 'product_owner'] %}
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label for="employee_id" class="form-label fw-bold">
                                            <i class="fas fa-users me-2"></i>Employee
                                        </label>
                                        <select class="form-select" id="employee_id" name="employee_id">
                                            <option value="">All Employees</option>
                                            {% if employees %}
                                            {% for employee in employees %}
                                            <option value="{{ employee.id }}" {% if request.args.get('employee_id')|int == employee.id %}selected{% endif %}>
                                                {{ employee.get_full_name() }}
                                            </option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                    {% elif current_user.role == 'employee' %}
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label class="form-label fw-bold d-block mb-2">
                                            <i class="fas fa-user me-2"></i>Status
                                        </label>
                                        <div class="alert alert-info mb-0 py-2">
                                            <i class="fas fa-user me-2"></i>
                                            Viewing your attendance logs
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="col-12 col-md-6 col-lg-3">
                                        <label class="form-label fw-bold d-block mb-2" style="visibility: hidden;">Action</label>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-2"></i>View Records
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Export Buttons -->
                    {% set show_export = False %}
                    {% set has_date_range = request.args.get('start_date') and request.args.get('end_date') %}
                    {% set has_employee = request.args.get('employee_id') %}
                    {% set is_today_view = not request.args.get('start_date') or (request.args.get('start_date') == request.args.get('end_date') and request.args.get('start_date') == today.strftime('%Y-%m-%d')) %}
                    
                    {% if (has_date_range and has_employee) or is_today_view %}
                        {% set show_export = True %}
                    {% endif %}
                    {% if show_export %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="{{ url_for('attendance.export_daily_attendance', start_date=request.args.get('start_date', today.strftime('%Y-%m-%d')), end_date=request.args.get('end_date', today.strftime('%Y-%m-%d')), employee_id=request.args.get('employee_id', ''), format='excel') }}" 
                                   class="btn btn-success" 
                                   target="_blank">
                                    <i class="fas fa-file-excel me-2"></i>Export to Excel
                                </a>
                                <a href="{{ url_for('attendance.export_daily_attendance', start_date=request.args.get('start_date', today.strftime('%Y-%m-%d')), end_date=request.args.get('end_date', today.strftime('%Y-%m-%d')), employee_id=request.args.get('employee_id', ''), format='pdf') }}" 
                                   class="btn btn-danger" 
                                   target="_blank">
                                    <i class="fas fa-file-pdf me-2"></i>Export to PDF
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Absent Days Summary -->
                    {% if user_absent_days %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Absent Days Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table employee-table">
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Absent Dates</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for employee_name, absent_dates in user_absent_days.items() %}
                                                <tr>
                                                    <td>{{ user_absent_days[employee_name]['user'].get_full_name() }}</td>
                                                    <td>
                                                         {% for date in absent_dates.absent_dates %}
                                                         <span class="badge bg-danger me-1">{{ date }}</span>
                                                         {% endfor %}
                                                     </td>
                                                </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="2">No absent days recorded for the selected period.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if request.args.get('employee_id') and employee_data and attendance_summary %}
                    <!-- Employee Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Employee Summary: {{ employee_data.name }}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <p><strong>Email:</strong> {{ employee_data.email }}</p>
                                            <p><strong>Fingerprint ID:</strong> {{ employee_data.fingerprint_number or 'Not Assigned' }}</p>
                                            <p><strong>Department:</strong> {{ employee_data.department }}</p>
                                        </div>
                                    </div>
                                    
                                    <h6 class="mb-3">Attendance Summary</h6>
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.total_days }}</h3>
                                                    <p class="mb-0">Total Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.present_days }}</h3>
                                                    <p class="mb-0">Present Days</p>
                    

                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.absent_days }}</h3>
                                                    <p class="mb-0">Absent Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.day_offs }}</h3>
                                                    <p class="mb-0">Day-offs</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.leave_days }}</h3>
                                                    <p class="mb-0">Leave Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.effective_days }}</h3>
                                                    <p class="mb-0">Effective Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.extra_hours }}</h3>
                                                    <p class="mb-0">Extra Hours</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.absent_days }}</h3>
                                                    <p class="mb-0">Absent Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.day_offs }}</h3>
                                                    <p class="mb-0">Day-offs</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.leave_days }}</h3>
                                                    <p class="mb-0">Leave Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.effective_days }}</h3>
                                                    <p class="mb-0">Effective Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.extra_hours }}</h3>
                                                    <p class="mb-0">Extra Hours</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.absent_days }}</h3>
                                                    <p class="mb-0">Absent Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.day_offs }}</h3>
                                                    <p class="mb-0">Day-offs</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.leave_days }}</h3>
                                                    <p class="mb-0">Leave Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.effective_days }}</h3>
                                                    <p class="mb-0">Effective Days</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.extra_hours }}</h3>
                                                    <p class="mb-0">Extra Hours</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h3>{{ attendance_summary.total_days - attendance_summary.present_days - attendance_summary.absent_days - attendance_summary.paid_leave - attendance_summary.unpaid_leave }}</h3>
                                                    <p class="mb-0">Day Off</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Today's Attendance -->
                    {% if not request.args.get('start_date') or (request.args.get('start_date') == request.args.get('end_date') and request.args.get('start_date') == today.strftime('%Y-%m-%d')) %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-subtitle mb-0">Today's Attendance</h6>
                        <div class="search-box" style="max-width: 300px; width: 100%;">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" 
                                       class="form-control border-start-0" 
                                       id="todayAttendanceSearch" 
                                       placeholder="Search by name, fingerprint, or status..."
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="clearTodaySearch" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table employee-table" id="todaysAttendanceTable">
                        <thead>
                            <tr>
                                <th>Fingerprint ID</th>
                                <th>Employee</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Duration</th>
                                <th>All Logs</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                            <tbody>
                                {% for user_id, data in daily_attendance.items() %}
                                    {% if data['user'] and data['user'].first_name and data['user'].last_name %}
                            <tr>
                                <td>
                                    {% if data['user'].fingerprint_number %}
                                        <span class="badge bg-info">{{ data['user'].fingerprint_number }}</span>
                                    {% else %}
                                        <span class="badge bg-warning">Not Assigned</span>
                                    {% endif %}
                                </td>
                                <td>{{ data['user'].get_full_name() }}</td>
                                <td>
                                        {% if data['check_in'] %}
                                        <span class="badge bg-success">{{ data['check_in'].timestamp.strftime('%I:%M %p') }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                        {% if data['check_out'] %}
                                        <span class="badge bg-danger">{{ data['check_out'].timestamp.strftime('%I:%M %p') }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                    <td>{{ data['duration'] or '-' }}</td>
                                <td>
                                    {% if data.get('all_logs') and data['all_logs']|length > 0 %}
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#logs-{{ user_id }}" aria-expanded="false">
                                            View All ({{ data['all_logs']|length }})
                                        </button>
                                            <div class="collapse mt-2" id="logs-{{ user_id }}">
                                            <div class="card card-body p-2">
                                                {% for log in data['all_logs'] %}
                                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                                    <div class="d-flex flex-column">
                                                        <span class="{% if log == data['check_in'] %}text-success fw-bold{% elif log == data['check_out'] %}text-danger fw-bold{% else %}text-muted{% endif %}">
                                                            {{ log.timestamp.strftime('%I:%M %p') }}
                                                        </span>
                                                        {% if log.device %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-fingerprint me-1"></i>{{ log.device.get_display_name() }}
                                                            </small>
                                                        {% elif log.device_ip %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-fingerprint me-1"></i>{{ log.device_ip }}
                                                            </small>
                                                        {% else %}
                                                            <small class="text-muted">Unknown Device</small>
                                                        {% endif %}
                                                    </div>
                                                    <span class="badge {% if log == data['check_in'] %}bg-success{% elif log == data['check_out'] %}bg-danger{% else %}bg-secondary{% endif %}">
                                                        {% if log == data['check_in'] %}Check-In{% elif log == data['check_out'] %}Check-Out{% else %}Additional{% endif %}
                                                    </span>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                        {% if data['status'] == 'present' %}
                                            {% if data.get('leave_type_name') %}
                                                <span class="badge bg-warning">{{ data['leave_type_name'] }} / Present</span>
                                            {% elif data.get('holiday_name') %}
                                                <span class="badge bg-info">{{ data['holiday_name'] }} / Present</span>
                                            {% elif data.get('permission_request') %}
                                                <span class="badge bg-info">Present (Permission)</span>
                                            {% else %}
                                                <span class="badge bg-success">Present</span>
                                            {% endif %}
                                        {% elif data['status'] == 'in_office' %}
                                            <span class="badge bg-info">In Office</span>
                                        {% elif data['status'] == 'Absent' %}
                                            <span class="badge bg-danger">Absent</span>
                                        {% elif data['status'] == 'DayOff' %}
                                            <span class="badge bg-secondary">Day Off</span>
                                        {% elif data['status'] == 'DayOff / Present' %}
                                            <span class="badge bg-primary">Day Off / Present</span>
                                        {% elif data['status'] == 'leave' %}
                                            {% if data.get('leave_type_name') %}
                                                <span class="badge bg-warning">{{ data['leave_type_name'] }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">Leave</span>
                                            {% endif %}
                                        {% elif data['status'] == 'paid_holiday' %}
                                            {% if data.get('holiday_name') %}
                                                <span class="badge bg-info">{{ data['holiday_name'] }}</span>
                                            {% else %}
                                                <span class="badge bg-info">Paid Holiday</span>
                                            {% endif %}
                                        {% elif 'Present /' in data['status'] %}
                                            <span class="badge bg-success">{{ data['status'] }}</span>
                                        {% elif data.get('holiday_name') and data['status'] != 'present' %}
                                            <span class="badge bg-info">{{ data['status'] }}</span>
                                        {% elif data['status'] == 'permission' %}
                                            <span class="badge bg-info">Permission</span>
                                        {% elif data['status'] == 'Leave Request' %}
                                            <span class="badge bg-warning">Leave Request</span>
                                        {% elif data['status'] == 'Permission Request' %}
                                            <span class="badge bg-info">Permission Request</span>
                                        {% elif data['status'] == 'Not Yet Joined' %}
                                            <span class="badge bg-light text-dark">Not Yet Joined</span>
                                        {% endif %}
                                </td>
                                <td>
                                    {% if data.get('holiday_name') %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-calendar-check me-1"></i>
                                            {{ data['holiday_name'] }}
                                        </span>
                                    {% elif 'Present /' in data['status'] %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-calendar-check me-1"></i>
                                            {{ data['status'].split(' / ')[1] }}
                                        </span>
                                    {% elif data.get('leave_type_name') and not data.get('leave_request') %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-calendar-times me-1"></i>
                                            {{ data.get('leave_type_name', 'Leave Request') }}
                                        </span>
                                    {% elif not data.get('leave_request') and not data.get('permission_request') and not (data.get('notes') and data['notes']|length > 0) %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                    
                                    {% if data.get('leave_request') %}
                                        <button type="button" class="btn btn-sm btn-warning ms-1" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#leaveModal{{ data['leave_request'].id }}"
                                                title="View Leave Request">
                                            <i class="fas fa-umbrella-beach me-1"></i>Leave
                                        </button>
                                    {% endif %}
                                    
                                    {% if data.get('permission_request') %}
                                        <button type="button" class="btn btn-sm btn-info ms-1" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#permissionModal{{ data['permission_request'].id }}"
                                                title="View Permission Request">
                                            <i class="fas fa-clock me-1"></i>Permission
                                        </button>
                                    {% endif %}
                                    
                                    {% if data.get('notes') and data['notes']|length > 0 %}
                                        {% for note in data['notes'] %}
                                        <button type="button" class="btn btn-sm btn-purple ms-1" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#noteModal{{ note.id }}"
                                                title="View Note">
                                            <i class="fas fa-sticky-note me-1"></i>Note
                                        </button>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                            </tr>
                                    {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    {% endif %}

                    <!-- Historical Data -->
                {% if historical_attendance %}
                    <h6 class="card-subtitle mb-3 mt-4">Historical Attendance</h6>
                    {% for date, date_data in historical_attendance.items() %}
                    <h6 class="mt-3">
                        {{ date }}
                        {% if date_data.is_paid_holiday %}
                            <span class="badge bg-info ms-2">{{ date_data.paid_holiday }}</span>
                        {% endif %}
                    </h6>
                    {% set attendance = date_data.attendance_data %}
                    <div class="table-responsive">
                        <table class="table employee-table">
                        <thead>
                            <tr>
                                <th>Fingerprint ID</th>
                                <th>Employee</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Duration</th>
                                <th>All Logs</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                                {% for user_id, data in attendance.items() %}
                                    {% if data['user'] and data['user'].first_name and data['user'].last_name %}
                                <tr>
                                    <td>
                                        {% if data['user'].fingerprint_number %}
                                            <span class="fingerprint-id-display">{{ data['user'].fingerprint_number }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">Not Assigned</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ data['user'].get_full_name() }}</td>
                                    <td>
                                        {% if data['check_in'] %}
                                        <span class="badge bg-success">{{ data['check_in'].timestamp.strftime('%I:%M %p') }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['check_out'] %}
                                        <span class="badge bg-danger">{{ data['check_out'].timestamp.strftime('%I:%M %p') }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ data['duration'] or '-' }}</td>
                                    <td>
                                        {% if data.get('all_logs') and data['all_logs']|length > 0 %}
                                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#logs-{{ date }}-{{ user_id }}" aria-expanded="false">
                                                View All ({{ data['all_logs']|length }})
                                            </button>
                                            <div class="collapse mt-2" id="logs-{{ date }}-{{ user_id }}">
                                                <div class="card card-body p-2">
                                                    {% for log in data['all_logs'] %}
                                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                                        <div class="d-flex flex-column">
                                                            <span class="{% if log == data['check_in'] %}text-success fw-bold{% elif log == data['check_out'] %}text-danger fw-bold{% else %}text-muted{% endif %}">
                                                                {{ log.timestamp.strftime('%I:%M %p') }}
                                                            </span>
                                                            {% if log.device %}
                                                                <small class="text-muted">
                                                                    <i class="fas fa-fingerprint me-1"></i>{{ log.device.get_display_name() }}
                                                                </small>
                                                            {% elif log.device_ip %}
                                                                <small class="text-muted">
                                                                    <i class="fas fa-fingerprint me-1"></i>{{ log.device_ip }}
                                                                </small>
                                                            {% else %}
                                                                <small class="text-muted">Unknown Device</small>
                                                            {% endif %}
                                                        </div>
                                                        <span class="badge {% if log == data['check_in'] %}bg-success{% elif log == data['check_out'] %}bg-danger{% else %}bg-secondary{% endif %}">
                                                            {% if log == data['check_in'] %}Check-In{% elif log == data['check_out'] %}Check-Out{% else %}Additional{% endif %}
                                                        </span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['status'] == 'present' %}
                                            {% if data.get('leave_type_name') %}
                                                <span class="badge bg-warning">{{ data['leave_type_name'] }} / Present</span>
                                            {% elif data.get('holiday_name') %}
                                                <span class="badge bg-info">{{ data['holiday_name'] }} / Present</span>
                                            {% elif data.get('permission_request') %}
                                                <span class="badge bg-info">Present (Permission)</span>
                                            {% else %}
                                                <span class="badge bg-success">Present</span>
                                            {% endif %}
                                        {% elif data['status'] == 'in_office' %}
                                            <span class="badge bg-info">In Office</span>
                                        {% elif data['status'] == 'Absent' %}
                                            <span class="badge bg-danger">Absent</span>
                                        {% elif data['status'] == 'DayOff' %}
                                            <span class="badge bg-secondary">Day Off</span>
                                        {% elif data['status'] == 'DayOff / Present' %}
                                            <span class="badge bg-primary">Day Off / Present</span>
                                        {% elif data['status'] == 'leave' %}
                                            {% if data.get('leave_type_name') %}
                                                <span class="badge bg-warning">{{ data['leave_type_name'] }}</span>
                                            {% else %}
                                                <span class="badge bg-warning">Leave</span>
                                            {% endif %}
                                        {% elif data['status'] == 'paid_holiday' %}
                                            {% if data.get('holiday_name') %}
                                                <span class="badge bg-info">{{ data['holiday_name'] }}</span>
                                            {% else %}
                                                <span class="badge bg-info">Paid Holiday</span>
                                            {% endif %}
                                        {% elif 'Present /' in data['status'] %}
                                            <span class="badge bg-success">{{ data['status'] }}</span>
                                        {% elif data.get('holiday_name') and data['status'] != 'present' %}
                                            <span class="badge bg-info">{{ data['status'] }}</span>
                                        {% elif data['status'] == 'On Leave' or data['status'] == 'Leave Request' %}
                                            <span class="badge bg-warning">Leave Request</span>
                                        {% elif data['status'] == 'Permission Request' %}
                                            <span class="badge bg-info">Permission Request</span>
                                        {% elif data['status'] == 'Not Yet Joined' %}
                                            <span class="badge bg-light text-dark">Not Yet Joined</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data.get('holiday_name') %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-calendar-check me-1"></i>
                                                {{ data['holiday_name'] }}
                                            </span>
                                        {% elif 'Present /' in data['status'] %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-calendar-check me-1"></i>
                                                {{ data['status'].split(' / ')[1] }}
                                            </span>
                                        {% elif data.get('leave_type_name') and not data.get('leave_request') %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-calendar-times me-1"></i>
                                                {{ data.get('leave_type_name', 'Leave Request') }}
                                            </span>
                                        {% elif not data.get('leave_request') and not data.get('permission_request') and not (data.get('notes') and data['notes']|length > 0) %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                        
                                        {% if data.get('leave_request') %}
                                            <button type="button" class="btn btn-sm btn-warning ms-1" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#leaveModal{{ date }}-{{ data['leave_request'].id }}"
                                                    title="View Leave Request">
                                                <i class="fas fa-umbrella-beach me-1"></i>Leave
                                            </button>
                                        {% endif %}
                                        
                                        {% if data.get('permission_request') %}
                                            <button type="button" class="btn btn-sm btn-info ms-1" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#permissionModal{{ date }}-{{ data['permission_request'].id }}"
                                                    title="View Permission Request">
                                                <i class="fas fa-clock me-1"></i>Permission
                                            </button>
                                        {% endif %}
                                        
                                        {% if data.get('notes') and data['notes']|length > 0 %}
                                            {% for note in data['notes'] %}
                                            <button type="button" class="btn btn-sm btn-purple ms-1" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#noteModal{{ date }}-{{ note.id }}"
                                                    title="View Note">
                                                <i class="fas fa-sticky-note me-1"></i>Note
                                            </button>
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                </tr>
                                    {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                    {% endfor %}
                {% else %}
                <div class="alert alert-info mt-3">
                    Select a date range and click "View Records" to see historical attendance data.
                </div>
                {% endif %}

                


                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if current_user.role != 'employee' %}
<script>
const syncButton = document.getElementById('syncButton');

function clearSyncAlerts() {
    // Remove all sync-related alerts from anywhere on the page
    const allAlerts = document.querySelectorAll('.alert, .sync-status-alert, .auto-sync-alert');
    allAlerts.forEach(alert => {
        const alertText = alert.textContent.toLowerCase();
        if (alertText.includes('sync') || 
            alertText.includes('operation') ||
            alertText.includes('running') ||
            alertText.includes('forbidden') ||
            alert.classList.contains('sync-status-alert') ||
            alert.classList.contains('auto-sync-alert')) {
            alert.remove();
        }
    });
}

function showSyncAlert(message, type = 'info') {
    // Clear existing alerts first
    clearSyncAlerts();
    
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `sync-status-alert alert alert-${type} alert-dismissible fade show`;
    
    // Set icon based on type
    let icon = 'fas fa-info-circle';
    let heading = 'Sync Status';
    
    switch(type) {
        case 'success':
            icon = 'fas fa-check-circle';
            heading = 'Sync Successful';
            break;
        case 'warning':
            icon = 'fas fa-exclamation-triangle';
            heading = 'Sync Warning';
            break;
        case 'danger':
            icon = 'fas fa-exclamation-circle';
            heading = 'Sync Failed';
            break;
        case 'info':
        default:
            icon = 'fas fa-info-circle';
            heading = 'Sync Info';
            break;
    }
    
    alertDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="flex-shrink-0">
                <i class="${icon} fa-lg me-3"></i>
            </div>
            <div class="flex-grow-1">
                <h6 class="alert-heading mb-1">${heading}</h6>
                <div>${message}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert the alert in the header area for better visibility
    const headerArea = document.querySelector('.employee-page-header');
    if (headerArea) {
        const alertContainer = document.createElement('div');
        alertContainer.className = 'mt-3';
        alertContainer.appendChild(alertDiv);
        headerArea.appendChild(alertContainer);
    } else {
        // Fallback to content area
        const contentArea = document.querySelector('.employee-card-body');
        if (contentArea) {
            contentArea.insertBefore(alertDiv, contentArea.firstChild);
        }
    }
    
    // Auto-dismiss info and warning alerts after 5 seconds
    if (type === 'info' || type === 'warning') {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function handleSyncClick() {
    // Check if sync is already in progress
    if (window.syncInProgress) {
        console.log('Sync already in progress, ignoring click');
        return;
    }
    
    // Check if button is disabled
    const syncButton = document.getElementById('syncButton');
    if (syncButton && syncButton.disabled) {
        console.log('Sync button is disabled, ignoring click');
        return;
    }
    
    // Proceed with sync
    triggerSync();
}

function updateSyncStatus(syncing, message = 'Syncing...') {
    const syncButton = document.getElementById('syncButton');
    if (syncButton) {
        syncButton.disabled = syncing;
        if (syncing) {
            syncButton.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> ${message}`;
            syncButton.classList.add('disabled');
        } else {
            syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Attendance Now';
            syncButton.classList.remove('disabled');
        }
    }
}

async function triggerSync(retryCount = 0) {
    // Prevent multiple simultaneous sync operations
    if (window.syncInProgress) {
        console.log('Sync already in progress, ignoring request');
        return;
    }
    
    console.log(`Starting sync operation${retryCount > 0 ? ` (retry ${retryCount})` : ''}...`);
    
    try {
        window.syncInProgress = true;
        updateSyncStatus(true, retryCount > 0 ? `Retrying... (${retryCount})` : 'Connecting...');
        console.log('Sync button disabled and status updated');
        
        // Remove all existing sync-related alerts immediately
        clearSyncAlerts();
        
        // Show simple connecting message
        showSyncAlert('Connecting to fingerprint devices...', 'info');
        
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        let response;
        try {
            console.log('Sending sync request to /attendance/manual-sync');
            
            // Create AbortController for timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('Sync timeout reached, aborting request...');
                controller.abort();
            }, 900000); // 15 minute timeout for sync operations (increased for large datasets)
            
            response = await fetch('/attendance/manual-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log('Sync response received:', response.status, response.statusText);
        } catch (networkError) {
            // Handle network errors (connection reset, timeout, etc.)
            console.error('Network error during manual sync:', networkError);
            
            if (networkError.name === 'AbortError') {
                // Sync operation timed out after 15 minutes
                showSyncAlert('Sync operation timed out after 15 minutes. This indicates the sync is processing a very large amount of data. The sync may still be running in the background. Please wait a few minutes and check the attendance logs to see if new records were added.', 'warning');
                
                // Don't retry automatically for timeouts - let user decide
                console.log('Sync aborted due to timeout - no automatic retry');
            } else if (networkError.message.includes('Failed to fetch') || 
                       networkError.message.includes('ERR_CONNECTION_RESET')) {
                // Connection reset - likely sync is taking too long
                showSyncAlert('Connection was reset by the server. This usually means the sync is taking longer than expected. Please wait a few minutes before trying again.', 'warning');
            } else {
                if (retryCount < 1) {
                    showSyncAlert(`Network error. Retrying... (${retryCount + 1}/1)`, 'warning');
                    setTimeout(() => triggerSync(retryCount + 1), 2000);
                    return;
                } else {
                    showSyncAlert(`Network error: ${networkError.message}. Please try again.`, 'danger');
                }
            }
            return;
        }
        
        let data;
        try {
            data = await response.json();
        } catch (e) {
            // Handle non-JSON responses
            console.error('Invalid JSON response:', e);
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        // Handle different HTTP status codes
        if (response.status === 403) {
            throw new Error('Access denied. You do not have permission to perform this action.');
        } else if (response.status === 404) {
            throw new Error('Sync endpoint not found. Please contact your administrator.');
        } else if (response.status >= 500) {
            throw new Error('Server error. Please try again later or contact your administrator.');
        }
        
        if (response.ok) {
            
            // Create enhanced sync status alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'sync-status-alert alert alert-dismissible fade show';
            
            let alertClass, icon, title, message;
            
            // Handle different response statuses
            if (data.status === 'success') {
                alertClass = 'alert-success';
                icon = 'fas fa-check-circle';
                title = 'All Done!';
                message = 'Attendance data synchronized successfully.';
                
                // Add detailed results for successful sync
                if (data.records_added !== undefined || data.records_updated !== undefined) {
                    message += '<div class="mt-2 sync-details">';
                    if (data.records_added > 0) {
                        message += `<span class="badge bg-primary me-2"><i class="fas fa-plus"></i> ${data.records_added} new</span>`;
                    }
                    if (data.records_updated > 0) {
                        message += `<span class="badge bg-info me-2"><i class="fas fa-sync-alt"></i> ${data.records_updated} updated</span>`;
                    }
                    if (data.records_added === 0 && data.records_updated === 0) {
                        message += '<span class="badge bg-secondary"><i class="fas fa-info-circle"></i> No new data</span>';
                    }
                    message += '</div>';
                    
                    // Add device information if available
                    if (data.devices_synced && data.devices_synced.length > 0) {
                        message += '<div class="mt-2"><small class="text-muted"><i class="fas fa-fingerprint me-1"></i>Synced from: ' + data.devices_synced.join(', ') + '</small></div>';
                    }
                }
            } else if (data.status === 'info') {
                // Check if this is a "sync already running" message
                if (data.message && data.message.toLowerCase().includes('already running')) {
                    alertClass = 'alert-warning';
                    icon = 'fas fa-clock';
                    title = 'Sync Already Running';
                    message = data.message + '<div class="mt-2"><small class="text-muted">Please wait for the current sync to complete before starting a new one.</small></div>';
                } else {
                    alertClass = 'alert-info';
                    icon = 'fas fa-info-circle';
                    title = 'Sync Status';
                    message = data.message;
                }
            } else {
                alertClass = 'alert-warning';
                icon = 'fas fa-exclamation-triangle';
                title = 'Sync Notice';
                message = data.message;
            }
            
            alertDiv.className += ' ' + alertClass;
            alertDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <i class="${icon} fa-lg me-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">${title}</h6>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insert the alert in the header area for better visibility
            const headerArea = document.querySelector('.employee-page-header');
            if (headerArea) {
                const alertContainer = document.createElement('div');
                alertContainer.className = 'mt-3';
                alertContainer.appendChild(alertDiv);
                headerArea.appendChild(alertContainer);
            } else {
                // Fallback to content area
                const contentArea = document.querySelector('.employee-card-body');
                if (contentArea) {
                    contentArea.insertBefore(alertDiv, contentArea.firstChild);
                }
            }
            
            // Auto-dismiss info alerts after 5 seconds
            if (data.status === 'info') {
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
            
            // Handle async sync response - trigger immediate data refresh
            if (data.status === 'success') {
                console.log(' Sync completed successfully - triggering immediate data refresh...');
                
                // Trigger immediate data fetch if auto-fetch system is available
                setTimeout(() => {
                    if (window.autoFetch && typeof window.autoFetch.fetchAllData === 'function') {
                        console.log(' Refreshing data after sync...');
                        window.autoFetch.fetchAllData().then(() => {
                            console.log(' Data refreshed successfully');
                        }).catch(err => {
                            console.error(' Error refreshing data:', err);
                        });
                    } else {
                        // Fallback: reload the page
                        console.log(' Reloading page...');
                        setTimeout(() => window.location.reload(), 1000);
                    }
                }, 500);
            }
        } else {
            throw new Error(data.message || 'Sync failed');
        }
    } catch (error) {
        // Remove any existing sync alerts first
        clearSyncAlerts();
        
        // Show enhanced error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'sync-status-alert alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle fa-lg me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1">Sync Failed</h6>
                    <div>${error.message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Insert the alert in the header area for better visibility
        const headerArea = document.querySelector('.employee-page-header');
        if (headerArea) {
            const alertContainer = document.createElement('div');
            alertContainer.className = 'mt-3';
            alertContainer.appendChild(alertDiv);
            headerArea.appendChild(alertContainer);
        } else {
            // Fallback to content area
            const contentArea = document.querySelector('.employee-card-body');
            if (contentArea) {
                contentArea.insertBefore(alertDiv, contentArea.firstChild);
            }
        }
    } finally {
        console.log('Sync operation completed, resetting state');
        window.syncInProgress = false;
        updateSyncStatus(false);
        console.log('Sync state reset complete');
    }
}

// Clear any existing sync alerts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for the page to fully load, then clear sync alerts
    setTimeout(clearSyncAlerts, 500);
});

// Auto-fetch status indicator animation
document.addEventListener('DOMContentLoaded', function() {
    const statusIndicator = document.getElementById('autoFetchStatus');
    if (!statusIndicator) return;
    
    // Pulse animation when fetching
    setInterval(() => {
        if (window.autoFetch && window.autoFetch.fetchInProgress) {
            statusIndicator.style.opacity = '1';
            statusIndicator.querySelector('i').style.animation = 'pulse 1s ease-in-out infinite';
            statusIndicator.querySelector('span').textContent = 'Checking for updates...';
        } else {
            statusIndicator.style.opacity = '0.7';
            statusIndicator.querySelector('i').style.animation = 'none';
            statusIndicator.querySelector('span').textContent = 'Auto-Update Active';
        }
    }, 500);
});
</script>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
</style>
{% endif %}

<script>
// Make auto-fetch status visible to all users on attendance page
document.addEventListener('DOMContentLoaded', function() {
    console.log(' Attendance Management page loaded - Auto-fetch system is active');
    console.log(' Auto-fetch will check for new data every 30 seconds while app is running');
    console.log(' Page will reload automatically when new attendance data is detected');
    console.log(' Manual sync button is still available for immediate sync');
    
    // Verify auto-fetch is initialized
    setTimeout(() => {
        if (window.autoFetch) {
            console.log(' Auto-fetch system confirmed active');
            console.log(`   - Fetch interval: ${window.autoFetch.fetchInterval / 1000} seconds`);
            console.log(`   - System enabled: ${window.autoFetch.enabled}`);
        } else {
            console.warn(' Auto-fetch system not detected - data may not auto-update');
        }
    }, 2000);
});
</script>

<!-- Leave Request Modals for Historical Attendance -->
{% for date_key, date_data in historical_attendance.items() %}
    {% for user_id, data in date_data.attendance_data.items() %}
        {% if data.get('leave_request') %}
            {% set leave = data['leave_request'] %}
            <div class="modal fade" id="leaveModal{{ date_key }}-{{ leave.id }}" tabindex="-1" aria-labelledby="leaveModalLabel{{ date_key }}-{{ leave.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="leaveModalLabel{{ date_key }}-{{ leave.id }}">
                                <i class="fas fa-umbrella-beach me-2"></i>Leave Request Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Employee</label>
                                <div class="form-control-plaintext">
                                    {{ leave.user.get_full_name() if leave.user else 'Unknown' }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Date Range</label>
                                <div class="form-control-plaintext">
                                    <i class="fas fa-calendar me-2"></i>
                                    {% if leave.start_date == leave.end_date %}
                                        {{ leave.start_date.strftime('%B %d, %Y') }}
                                    {% else %}
                                        {{ leave.start_date.strftime('%B %d, %Y') }} - {{ leave.end_date.strftime('%B %d, %Y') }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Leave Type</label>
                                <div class="form-control-plaintext">
                                    {{ leave.leave_type.name if leave.leave_type else 'N/A' }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Reason</label>
                                <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ leave.reason }}</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Status</label>
                                    <div class="form-control-plaintext">
                                        <span class="badge bg-success">{{ leave.status|title }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Created At</label>
                                    <div class="form-control-plaintext">
                                        {{ leave.created_at.strftime('%Y-%m-%d %H:%M:%S') if leave.created_at else 'N/A' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        {% if data.get('permission_request') %}
            {% set permission = data['permission_request'] %}
            <div class="modal fade" id="permissionModal{{ date_key }}-{{ permission.id }}" tabindex="-1" aria-labelledby="permissionModalLabel{{ date_key }}-{{ permission.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="permissionModalLabel{{ date_key }}-{{ permission.id }}">
                                <i class="fas fa-clock me-2"></i>Permission Request Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Employee</label>
                                <div class="form-control-plaintext">
                                    {{ permission.user.get_full_name() if permission.user else 'Unknown' }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Date</label>
                                <div class="form-control-plaintext">
                                    <i class="fas fa-calendar me-2"></i>{{ permission.start_time.strftime('%B %d, %Y') if permission.start_time else 'N/A' }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Time Range</label>
                                <div class="form-control-plaintext">
                                    <i class="fas fa-clock me-2"></i>
                                    {% if permission.start_time and permission.end_time %}
                                        {{ permission.start_time.strftime('%I:%M %p') }} - {{ permission.end_time.strftime('%I:%M %p') }}
                                        {% set duration = (permission.end_time - permission.start_time).total_seconds() / 3600 %}
                                        <span class="badge bg-info ms-2">{{ "%.1f"|format(duration) }} hours</span>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Reason</label>
                                <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ permission.reason }}</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Status</label>
                                    <div class="form-control-plaintext">
                                        <span class="badge bg-success">{{ permission.status|title }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Created At</label>
                                    <div class="form-control-plaintext">
                                        {{ permission.created_at.strftime('%Y-%m-%d %H:%M:%S') if permission.created_at else 'N/A' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        {% if data.get('notes') and data['notes']|length > 0 %}
            {% for note in data['notes'] %}
            <div class="modal fade" id="noteModal{{ date_key }}-{{ note.id }}" tabindex="-1" aria-labelledby="noteModalLabel{{ date_key }}-{{ note.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="noteModalLabel{{ date_key }}-{{ note.id }}">
                                <i class="fas fa-sticky-note me-2"></i>Note Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Employee</label>
                                <div class="form-control-plaintext">
                                    {{ note.user.get_full_name() if note.user else 'Unknown' }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Date Range</label>
                                <div class="form-control-plaintext">
                                    {% if note.start_date == note.end_date %}
                                        <i class="fas fa-calendar me-2"></i>{{ note.start_date.strftime('%B %d, %Y') }}
                                    {% else %}
                                        <i class="fas fa-calendar me-2"></i>{{ note.start_date.strftime('%B %d, %Y') }} - {{ note.end_date.strftime('%B %d, %Y') }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Comment</label>
                                <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ note.comment }}</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Created By</label>
                                    <div class="form-control-plaintext">
                                        {{ note.created_by.get_full_name() if note.created_by else 'Unknown' }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Created At</label>
                                    <div class="form-control-plaintext">
                                        {{ note.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    {% endfor %}
{% endfor %}

<!-- Leave Request Modals for Daily Attendance -->
{% for user_id, data in daily_attendance.items() %}
    {% if data.get('leave_request') %}
        {% set leave = data['leave_request'] %}
        <div class="modal fade" id="leaveModal{{ leave.id }}" tabindex="-1" aria-labelledby="leaveModalLabel{{ leave.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="leaveModalLabel{{ leave.id }}">
                            <i class="fas fa-umbrella-beach me-2"></i>Leave Request Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Employee</label>
                            <div class="form-control-plaintext">
                                {{ leave.user.get_full_name() if leave.user else 'Unknown' }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date Range</label>
                            <div class="form-control-plaintext">
                                <i class="fas fa-calendar me-2"></i>
                                {% if leave.start_date == leave.end_date %}
                                    {{ leave.start_date.strftime('%B %d, %Y') }}
                                {% else %}
                                    {{ leave.start_date.strftime('%B %d, %Y') }} - {{ leave.end_date.strftime('%B %d, %Y') }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Leave Type</label>
                            <div class="form-control-plaintext">
                                {{ leave.leave_type.name if leave.leave_type else 'N/A' }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Reason</label>
                            <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ leave.reason }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <div class="form-control-plaintext">
                                    <span class="badge bg-success">{{ leave.status|title }}</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Created At</label>
                                <div class="form-control-plaintext">
                                    {{ leave.created_at.strftime('%Y-%m-%d %H:%M:%S') if leave.created_at else 'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if data.get('permission_request') %}
        {% set permission = data['permission_request'] %}
        <div class="modal fade" id="permissionModal{{ permission.id }}" tabindex="-1" aria-labelledby="permissionModalLabel{{ permission.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="permissionModalLabel{{ permission.id }}">
                            <i class="fas fa-clock me-2"></i>Permission Request Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Employee</label>
                            <div class="form-control-plaintext">
                                {{ permission.user.get_full_name() if permission.user else 'Unknown' }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date</label>
                            <div class="form-control-plaintext">
                                <i class="fas fa-calendar me-2"></i>{{ permission.start_time.strftime('%B %d, %Y') if permission.start_time else 'N/A' }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Time Range</label>
                            <div class="form-control-plaintext">
                                <i class="fas fa-clock me-2"></i>
                                {% if permission.start_time and permission.end_time %}
                                    {{ permission.start_time.strftime('%I:%M %p') }} - {{ permission.end_time.strftime('%I:%M %p') }}
                                    {% set duration = (permission.end_time - permission.start_time).total_seconds() / 3600 %}
                                    <span class="badge bg-info ms-2">{{ "%.1f"|format(duration) }} hours</span>
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Reason</label>
                            <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ permission.reason }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Status</label>
                                <div class="form-control-plaintext">
                                    <span class="badge bg-success">{{ permission.status|title }}</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Created At</label>
                                <div class="form-control-plaintext">
                                    {{ permission.created_at.strftime('%Y-%m-%d %H:%M:%S') if permission.created_at else 'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if data.get('notes') and data['notes']|length > 0 %}
        {% for note in data['notes'] %}
        <div class="modal fade" id="noteModal{{ note.id }}" tabindex="-1" aria-labelledby="noteModalLabel{{ note.id }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="noteModalLabel{{ note.id }}">
                            <i class="fas fa-sticky-note me-2"></i>Note Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Employee</label>
                            <div class="form-control-plaintext">
                                {{ note.user.get_full_name() if note.user else 'Unknown' }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date Range</label>
                            <div class="form-control-plaintext">
                                {% if note.start_date == note.end_date %}
                                    <i class="fas fa-calendar me-2"></i>{{ note.start_date.strftime('%B %d, %Y') }}
                                {% else %}
                                    <i class="fas fa-calendar me-2"></i>{{ note.start_date.strftime('%B %d, %Y') }} - {{ note.end_date.strftime('%B %d, %Y') }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Comment</label>
                            <div class="form-control-plaintext" style="white-space: pre-wrap;">{{ note.comment }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Created By</label>
                                <div class="form-control-plaintext">
                                    {{ note.created_by.get_full_name() if note.created_by else 'Unknown' }}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Created At</label>
                                <div class="form-control-plaintext">
                                    {{ note.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
{% endfor %}

<style>
.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}
.btn-purple:hover {
    background-color: #5a32a3;
    border-color: #5a32a3;
    color: white;
}

/* Search box styling */
.search-box .input-group-text {
    border-right: none;
}

.search-box .form-control {
    border-left: none;
}

.search-box .form-control:focus {
    border-color: #ced4da;
    box-shadow: none;
}

.search-box .form-control:focus + .btn {
    border-color: #ced4da;
}
</style>

<script>
// AJAX Search for Today's Attendance
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('todayAttendanceSearch');
    const clearBtn = document.getElementById('clearTodaySearch');
    const table = document.getElementById('todaysAttendanceTable');
    
    if (!searchInput || !table) {
        return; // Exit if elements don't exist
    }
    
    let searchTimeout;
    let originalRows = [];
    
    // Store original rows on page load
    const tbody = table.querySelector('tbody');
    if (tbody) {
        originalRows = Array.from(tbody.querySelectorAll('tr'));
    }
    
    // Show/hide clear button
    function toggleClearButton() {
        if (searchInput.value.trim().length > 0) {
            clearBtn.style.display = 'block';
        } else {
            clearBtn.style.display = 'none';
        }
    }
    
    // Filter rows based on search term
    function filterRows(searchTerm) {
        if (!tbody) return;
        
        const term = searchTerm.toLowerCase().trim();
        
        if (term === '') {
            // Show all original rows
            originalRows.forEach(row => {
                row.style.display = '';
            });
            return;
        }
        
        // Filter rows
        originalRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) {
                row.style.display = 'none';
                return;
            }
            
            // Get text from all cells
            let rowText = '';
            cells.forEach(cell => {
                rowText += ' ' + cell.textContent.toLowerCase();
            });
            
            // Check if search term matches
            if (rowText.includes(term)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Handle search input
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value;
        toggleClearButton();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Debounce search
        searchTimeout = setTimeout(() => {
            filterRows(searchTerm);
        }, 300);
    });
    
    // Handle clear button
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        toggleClearButton();
        filterRows('');
        searchInput.focus();
    });
    
    // Handle Enter key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            filterRows(e.target.value);
        }
    });
    
    // Initialize clear button state
    toggleClearButton();
});
</script>

{% endblock %}